@model IEnumerable<AirOut.Web.Models.Bms_Bill_Ap>
@{
    ViewBag.Title = "帐务操作";
    var Num = 1;
    var ArrStatus = AirOut.Web.Extensions.Common.GetEnumToDic("UseStatusEnum", "AirOut.Web.Models.AirOutEnumType").Select(n => new { ID = n.Value.ToString(), TEXT = n.DisplayName, Value = n.Value, DisplayName = n.DisplayName });
    var ArrAuditStatus = AirOut.Web.Extensions.Common.GetEnumToDic("AuditStatusEnum", "AirOut.Web.Models.AirOutEnumType").Select(n => new { ID = n.Value.ToString(), TEXT = n.DisplayName, Value = n.Value, DisplayName = n.DisplayName });
    var ArrUseStatus = AirOut.Web.Extensions.Common.GetEnumToDic("UseStatusIsOrNoEnum", "AirOut.Web.Models.AirOutEnumType").Select(n => new { ID = n.Value.ToString(), TEXT = n.DisplayName, Value = n.Value, DisplayName = n.DisplayName });
    var ArrBms_BillCreate_Status = AirOut.Web.Extensions.Common.GetEnumToDic("Bms_BillCreate_Status", "AirOut.Web.Models.AirOutEnumType").Select(n => new { ID = n.Value.ToString(), TEXT = n.DisplayName, Value = n.Value, DisplayName = n.DisplayName });
}
<!--DataGrid 回车Editor下一个 和 为控件添加 Key事件 -->
<script src="~/Scripts/jsext.js?date=2019013001"></script>
<!--真实 下载进度条 -->
<script async defer src="~/Scripts/DownLoadProgress.js"></script>
<script type="text/javascript">
    //表单唯一值，防止重复提交
    var ActionGuidName = '@(ViewData["ActionGuidName"]??"")';
    var ActionGuid = '@(ViewData["ActionGuidName"] == null ? "" : (ViewData[ViewData["ActionGuidName"].ToString()] ?? ""))';

    //异步获取 选择框
    var ArrIsLoadWin ={
        IsLoadArApEdit_PopupWin : false
    };
    //AsyncGetMyWin(url,IsLoadMyWin,InitMyWinFucName,Async_Load)整合在jsext
</script>

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>@ViewBag.Title</h2>
        <ol class="breadcrumb">
            <li>
                <a href="@Url.Action("Index", "Home")">主页</a>
            </li>
            <li>
                <a href="#">结算</a>
            </li>
            <li class="active">
                <strong>@ViewBag.Title</strong>
            </li>
        </ol>
    </div>
    <div class="col-lg-2">

    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-content">
                    <form id="searchform" method="post" style="padding-bottom:10px; width:auto">
                        <div id="div_search" style="padding-top:5px; padding-bottom:3px; width:auto;" class="easyui-panel" title="查询条件"
                             data-options="collapsible:false">
                            <div class="row col-md-12">
                                <div class="form-group col-md-3">
                                    <label for="Dzbh_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">业务编号:</label>
                                    <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                        <input id="Dzbh_Q" name="Dzbh_Q" tabindex="@(Num++)" data-options="prompt1:'业务编号'" style="width:100%" class="easyui-textbox" type="text" />
                                    </div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="Entrustment_Name_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">委托方:</label>
                                    <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                        <input id="Entrustment_Name_Q" name="Entrustment_Name_Q" tabindex="@(Num++)" data-options="prompt1:'委托方'" style="width:100%" class="easyui-combogrid" type="text" />
                                    </div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="Carriage_Account_Code_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">结算方:</label>
                                    <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                        <input id="Carriage_Account_Code_Q" name="Carriage_Account_Code_Q" tabindex="@(Num++)" data-options="prompt1:'结算方'" style="width:100%" class="easyui-combogrid" type="text" />
                                    </div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="MBL_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">总单号:</label>
                                    <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                        <input id="MBL_Q" name="MBL_Q" tabindex="@(Num++)" data-options="prompt1:'总单号'" style="width:100%" class="easyui-textbox" type="text" />
                                    </div>
                                </div>
                            </div>
                            <!------------row---------------->
                            <div class="row col-md-12">
                                <div class="form-group col-md-3">
                                    <label for="_Flight_Date_Want_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">航班日期起:</label>
                                    <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                        <input id="_Flight_Date_Want_Q" name="_Flight_Date_Want_Q" tabindex="@(Num++)" data-options="prompt1:'航班日期起'" style="width:100%" class="easyui-datebox" type="text" />
                                    </div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="Flight_Date_Want__Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">航班日期讫:</label>
                                    <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                        <input id="Flight_Date_Want__Q" name="Flight_Date_Want__Q" tabindex="@(Num++)" data-options="prompt1:'航班日期讫'" style="width:100%" class="easyui-datebox" type="text" />
                                    </div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="ADDWHO_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">接单人:</label>
                                    <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                        <input id="ADDWHO_Q" name="ADDWHO_Q" tabindex="@(Num++)" data-options="prompt1:'接单人'" style="width:100%" class="easyui-combogrid" type="text" />
                                    </div>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="SallerId_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">销售:</label>
                                    <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                        <input id="SallerId_Q" name="SallerId_Q" tabindex="@(Num++)" data-options="prompt1:'销售'" style="width:100%" class="easyui-combogrid" type="text" />
                                    </div>
                                </div>
                            </div>
                            <div id="div_collapsible">
                                <!------------row---------------->
                                <div class="row col-md-12">
                                    <div class="form-group col-md-3">
                                        <label for="End_Port_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">目的港:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="End_Port_Q" name="End_Port_Q" tabindex="@(Num++)" data-options="prompt1:'目的港'" style="width:100%" class="easyui-combogrid" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="Is_DCZ_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">代操作:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Is_DCZ_Q" name="Is_DCZ_Q" tabindex="@(Num++)" data-options="prompt1:'代操作'" style="width:100%" class="easyui-combogrid" type="text" />
                                        </div>
                                    </div>
                                </div>
                                <!------------row---------------->
                                <div class="row col-md-12">
                                    <div class="form-group col-md-3">
                                        <label for="Charge_Code_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">费用代码:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Charge_Code_Q" name="Charge_Code_Q" tabindex="@(Num++)" data-options="prompt1:'费用代码'" style="width:100%" class="easyui-combogrid" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="Charge_Desc_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">费用名称:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Charge_Desc_Q" name="Charge_Desc_Q" tabindex="@(Num++)" data-options="prompt1:'费用名称'" style="width:100%" class="easyui-textbox" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="Money_Code_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">币种:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Money_Code_Q" name="Money_Code_Q" tabindex="@(Num++)" data-options="prompt1:'币种名称'" style="width:100%" class="easyui-combogrid" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="Payway_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">支付方式:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Payway_Q" name="Payway_Q" tabindex="@(Num++)" data-options="prompt1:'支付方式'" style="width:100%" class="easyui-combogrid" type="text" />
                                        </div>
                                    </div>
                                </div>
                                <!------------row---------------->
                                <div class="row col-md-12">
                                    <div class="form-group col-md-3">
                                        <label for="Bill_Type_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">账单类型:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Bill_Type_Q" name="Bill_Type_Q" tabindex="@(Num++)" data-options="prompt1:'账单类型'" style="width:100%" class="easyui-combogrid" type="text" />
                                            @*<input id="IsCN_Q" name="IsCN_Q" tabindex="@(Num++)" class="easyui-checkbox" type="checkbox" /><span style="font-size:5pt;">C/N</span>
                                            <input id="IsDN_Q" name="IsDN_Q" tabindex="@(Num++)" class="easyui-checkbox" type="checkbox" /><span style="font-size:5pt;">D/N</span>
                                            <input id="IsFP_Q" name="IsFP_Q" tabindex="@(Num++)" class="easyui-checkbox" type="checkbox" /><span style="font-size:5pt;">FP</span>
                                            <input id="IsFTYF_Q" name="IsFTYF_Q" tabindex="@(Num++)" class="easyui-checkbox" type="checkbox" /><span style="font-size:5px;">分摊应付</span>*@
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="_Bill_Date_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">账单日期起:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="_Bill_Date_Q" name="_Bill_Date_Q" tabindex="@(Num++)" data-options="prompt1:'账单日期起'" style="width:100%" class="easyui-datebox" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="Bill_Date__Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">账单日期讫:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Bill_Date__Q" name="Bill_Date__Q" tabindex="@(Num++)" data-options="prompt1:'账单日期讫'" style="width:100%" class="easyui-datebox" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="BillADDWHO_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">制单人员:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="BillADDWHO_Q" name="BillADDWHO_Q" tabindex="@(Num++)" data-options="prompt1:'制单人员'" style="width:100%" class="easyui-combogrid" type="text" />
                                        </div>
                                    </div>
                                </div>
                                <!------------row---------------->
                                <div class="row col-md-12">
                                    <div class="form-group col-md-3">
                                        <label for="Sumbmit_Name_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">提交人:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Sumbmit_Name_Q" name="Sumbmit_Name_Q" tabindex="@(Num++)" data-options="prompt1:'提交人'" style="width:100%" class="easyui-combogrid" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="AuditStatus_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">审核标志:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="AuditStatus_Q" name="AuditStatus_Q" tabindex="@(Num++)" data-options="prompt1:'审核标志'" style="width:100%" class="easyui-combogrid" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="AuditNo_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">审核号:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="AuditNo_Q" name="AuditNo_Q" tabindex="@(Num++)" data-options="prompt1:'审核号'" style="width:100%" class="easyui-textbox" type="text" />
                                        </div>
                                    </div>
                                </div>
                                <!------------row---------------->
                                <div class="row col-md-12">
                                    <div class="form-group col-md-3">
                                        <label for="Sumbmit_Status_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">提交标志:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Sumbmit_Status_Q" name="Sumbmit_Status_Q" tabindex="@(Num++)" data-options="prompt1:'提交标志'" style="width:100%" class="easyui-combogrid" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="Sumbmit_No_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">提交号:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Sumbmit_No_Q" name="Sumbmit_No_Q" tabindex="@(Num++)" data-options="prompt1:'提交号'" style="width:100%" class="easyui-textbox" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="_Sumbmit_Date_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">提交日期起:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="_Sumbmit_Date_Q" name="_Sumbmit_Date_Q" tabindex="@(Num++)" data-options="prompt1:'提交日期起'" style="width:100%" class="easyui-datebox" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="Sumbmit_Date__Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">提交日期讫:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Sumbmit_Date__Q" name="Sumbmit_Date__Q" tabindex="@(Num++)" data-options="prompt1:'提交日期讫'" style="width:100%" class="easyui-datebox" type="text" />
                                        </div>
                                    </div>
                                </div>
                                <!------------row---------------->
                                <div class="row col-md-12">
                                    <div class="form-group col-md-3">
                                        <label for="Invoice_Status_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">开票标志:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Invoice_Status_Q" name="Invoice_Status_Q" tabindex="@(Num++)" data-options="prompt1:'开票标志'" style="width:100%" class="easyui-combogrid" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="Invoice_No_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">开票号:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Invoice_No_Q" name="Invoice_No_Q" tabindex="@(Num++)" data-options="prompt1:'开票号'" style="width:100%" class="easyui-textbox" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="_Invoice_Date_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">开票日期起:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="_Invoice_Date_Q" name="_Invoice_Date_Q" tabindex="@(Num++)" data-options="prompt1:'开票日期起'" style="width:100%" class="easyui-datebox" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="Invoice_Date__Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">开票日期讫:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Invoice_Date__Q" name="Invoice_Date__Q" tabindex="@(Num++)" data-options="prompt1:'开票日期讫'" style="width:100%" class="easyui-datebox" type="text" />
                                        </div>
                                    </div>
                                </div>
                                <!------------row---------------->
                                <div class="row col-md-12">
                                    <div class="form-group col-md-3">
                                        <label for="SignIn_Status_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">签收标志:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="SignIn_Status_Q" name="SignIn_Status_Q" tabindex="@(Num++)" data-options="prompt1:'签收标志'" style="width:100%" class="easyui-combogrid" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="SignIn_No_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">签收号:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="SignIn_No_Q" name="SignIn_No_Q" tabindex="@(Num++)" data-options="prompt1:'签收号'" style="width:100%" class="easyui-textbox" type="text" />
                                        </div>
                                    </div>
                                </div>
                                <!------------row---------------->
                                <div class="row col-md-12">
                                    <div class="form-group col-md-3">
                                        <label for="SellAccount_Status_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">销账标志:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="SellAccount_Status_Q" name="SellAccount_Status_Q" tabindex="@(Num++)" data-options="prompt1:'签收标志'" style="width:100%" class="easyui-combogrid" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="_SellAccount_Date_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">销账日期起:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="_SellAccount_Date_Q" name="_SellAccount_Date_Q" tabindex="@(Num++)" data-options="prompt1:'销账日期起'" style="width:100%" class="easyui-datebox" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="SellAccount_Date__Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">销账日期讫:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="SellAccount_Date__Q" name="SellAccount_Date__Q" tabindex="@(Num++)" data-options="prompt1:'销账日期讫'" style="width:100%" class="easyui-datebox" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="SellAccount_Name_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">销账人:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="SellAccount_Name_Q" name="SellAccount_Name_Q" tabindex="@(Num++)" data-options="prompt1:'销账人'" style="width:100%" class="easyui-textbox" type="text" />
                                        </div>
                                    </div>
                                </div>
                                <!------------row---------------->
                                <div class="row col-md-12">
                                    <div class="form-group col-md-3">
                                        <label for="_Invoice_No_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">发票号起:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="_Invoice_No_Q" name="_Invoice_No_Q" tabindex="@(Num++)" data-options="prompt1:'发票号起'" style="width:100%;" class="easyui-numberbox" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="Invoice_No__Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">发票号讫:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Invoice_No__Q" name="Invoice_No__Q" tabindex="@(Num++)" data-options="prompt1:'发票号讫'" style="width:100%;" class="easyui-numberbox" type="text" />
                                        </div>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="Cancel_Status_Q" class="col-md-4" style=" line-height:28px; padding-left:0px; padding-right: 0px;">作废标志:</label>
                                        <div class="col-md-8" style="padding-left:0px; padding-right: 0px;">
                                            <input id="Cancel_Status_Q" name="Cancel_Status_Q" tabindex="@(Num++)" data-options="prompt1:'作废标志'" style="width:100%;" value="0" class="easyui-combogrid" type="text" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row col-md-12" style="text-align:center;">
                                <button id="btn-search" class="btn btn-primary">
                                    <i class="fa fa-search"></i>
                                    搜索
                                </button>
                                <button id="btn-reset" class="btn btn-default">
                                    <i class="fa fa-reset"></i>
                                    重置
                                </button>
                                <button type="button" class="btn btn-warning" id="btnAddSearch">增加查询</button>
                            </div>
                        </div>
                    </form>
                    <div class="table-responsive" id="financetable">
                        @Html.Partial("ListView", Model)
                        <div id="finance_toolbar" style="height:auto">
                            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-sort-by-attributes',plain:true" onclick="AmountToatal.call(this)">金额汇总</a>
                            @if (Html.IsAuthorize("Bms_Bill_Aps", "Edit", "Edit"))
                            {
                                <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save',plain:true" onclick="accept.call(this)">保存</a>
                            }
                            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-undo',plain:true" onclick="reject.call(this)">取消</a>
                            <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-refresh',plain:true" onclick="reload.call(this)">刷新</a>
                            @if (Html.IsAuthorize("Bms_Bill_Aps", "Import", "Import"))
                            {
                                @*<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="removeit.call(this)">应收款对账单</a>
                                <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="removeit.call(this)">应付款对账单</a>
                                <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="removeit.call(this)">结算方明细</a>
                                <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="removeit.call(this)">应收款对账单（旧）</a>
                                <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="removeit.call(this)">应付款对账单（旧）</a>
                                <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-remove',plain:true" onclick="removeit.call(this)">结算方明细（旧）</a>*@
                            }
                            @if (Html.IsAuthorize("Bms_Bill_Aps", "Export", "Export"))
                            {
                                <a href="javascript:void(0)" id="btnExportE"class="easyui-linkbutton" data-options="iconCls:'icon-download-alt',plain:true">导出 Excel</a>
                                <a href="javascript:void(0)" id="btnExportP" class="easyui-linkbutton" data-options="iconCls:'icon-download-alt',plain:true">打印</a>
                            }
                        </div>
                    </div>
                    <div class="table-responsive">
                        <div class="row col-md-12" style="text-align:center; margin-top:10px;">
                            <button type="button" class="btn btn-default" id="btnTotalSelted">统计选中项</button>
                            <button type="button" class="btn btn-default" id="btnFeeDtl">费用明细</button>
                            <button type="button" class="btn btn-default" id="btnBillRemove">账单移除</button>
                            <button type="button" class="btn btn-default" id="btnBillCancel">账单作废</button>
                            <button type="button" class="btn btn-default" id="btnEditBillType">修改账单类型</button>
                            <button type="button" class="btn btn-default" id="btnEdit">修改结算方</button>
                            <button type="button" class="btn btn-default" id="btnAudit">审核</button>
                            <button type="button" class="btn btn-default" id="btnAuditCancel">取消审核</button>
                            <br/>
                            <button type="button" class="btn btn-default" id="btnApSubmit">应付提交</button>
                            <button type="button" class="btn btn-default" id="btnArSubmit">应收提交</button>
                            <button type="button" class="btn btn-default" id="btnAddSubmit">添加提交</button>
                            <button type="button" class="btn btn-default" id="btnEditSubmit">提交修改</button>
                            <button type="button" class="btn btn-default" id="btnCancelSubmit">取消提交</button>
                            <button type="button" class="btn btn-default" id="btnAddDNFP">开具D/N号</button>
                            <button type="button" class="btn btn-default" id="btnInvoice">开票</button>
                            <button type="button" class="btn btn-default" id="btnCancelInvoice">取消开票</button>
                            <button type="button" class="btn btn-default" id="btnInvoiceCancel">发票作废</button>
                            <button type="button" class="btn btn-default" id="btnSignIn">签收</button>
                            <button type="button" class="btn btn-default" id="btnSignInCancel">取消签收</button>
                            <button type="button" class="btn btn-default" id="btnSettleAccount">销账</button>
                            <button type="button" class="btn btn-default" id="btnNASATaxRate" style="display:none;">航天增值税</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        @Html.Partial("FeeDtlListView", null)
                    </div>
                </div>
                <!-- end ibox-content -->
            </div>
        </div>
    </div>
</div>
<div id="importwindow" class="easyui-window" title="Excel 导入" data-options="modal:true,collapsible:false,minimizable:false,maximizable:false,closed:true,iconCls:'icon-paperclip'" style="width:500px;height:260px;padding:10px;">
    <p><input type="file" name="file_upload" id="file_upload" /></p>
</div>
<!--用于后端 加载dom并且渲染成EasyUI样式-->
<div id="EasyUIDom" style="height:35px; clear:both; border:0 solid;"></div>
<div id="BMS_Export" class="easyui-menu" data-option="hideOnUnhover:false;" style="width:120px; position:absolute;">
    <div>应付对账单</div>
    <div>应收对账单</div>
    <div>应付对账单(含税)</div>
    <div>应收对账单(含税)</div>
    <div>应付明细</div>
    <div>应收明细</div>
    <div>应付费用明细</div>
    <div>应收费用明细</div>
    <div>结算方应付明细</div>
    <div>结算方应收明细</div>
</div>
<div id="BMS_Print" class="easyui-menu" data-option="hideOnUnhover:false;" style="width:120px; position:absolute;">
    <div>应付对账单</div>
    <div>应收对账单</div>
    <div>应付对账单(含税)</div>
    <div>应收对账单(含税)</div>
    <div>结算方应付明细</div>
    <div>结算方应收明细</div>
    <div>业务费用报销单</div>
</div>
@section Scripts {
    <script type="text/javascript">
        const ArrStatus = @Html.Raw(ArrStatus == null ? "[]" : Newtonsoft.Json.JsonConvert.SerializeObject(ArrStatus));//数据状态
        const ArrAuditStatus = @Html.Raw(ArrAuditStatus == null ? "[]" : Newtonsoft.Json.JsonConvert.SerializeObject(ArrAuditStatus));//数据审核状态
        const ArrUseStatus = @Html.Raw(ArrUseStatus == null ? "[]" : Newtonsoft.Json.JsonConvert.SerializeObject(ArrUseStatus));//数据bool状态
        const ArrBms_BillCreate_Status = @Html.Raw(ArrBms_BillCreate_Status == null ? "[]" : Newtonsoft.Json.JsonConvert.SerializeObject(ArrBms_BillCreate_Status));//账单产生标志
        const ArrBill_Type = [
            {ID:"C/N",TEXT:"C/N",IDTEXT:"C/N"},
            {ID:"D/N",TEXT:"D/N",IDTEXT:"D/N"},
            {ID:"FP",TEXT:"发票",IDTEXT:"FP|发票"},
            {ID:"FTYF",TEXT:"分摊应付",IDTEXT:"FTYF|分摊应付"}
        ];

        const Editable = '@Html.IsAuthorize("Finances"), "Index", "Edit")';//编辑权限
        const Curr$dgCtrl = 'finance'; //当前dg是应收/应付账单 id前缀

        //应收/应付 标志
        var IsBmsBillAr  = "@(ViewData["IsBmsBillAr"] == null ? "" : ViewData["IsBmsBillAr"].ToString())";
        var markAll = '';//标记是否选中了全选按钮
        var $dg = $('#finance_datagrid');
        var $dg_dtl = $('#finance_dtl_datagrid');
        var editIndex = undefined;

        $(function () {
            $("#file_upload").uploadifive({
                'height': 30,
                'fileTypeDesc': 'Excel 2010 Files',
                'fileTypeExts': '*.xlsx',
                'uploadScript': '/FileUpload/Upload',
                'buttonText': '选择EXCEL',
                'multi': true,
                'displayData': 'speed',
                'formData': { 'modelType': 'Bms_Bill_Ap' },
                'width': 120,
                'successTimeout': 100000,
                'onFallback': function () {
                    $.messager.alert('导入错误', '导入错误，请重试！<br>', 'error');
                    $('#file_upload').uploadifive('clearQueue')
                },
                'onSelect': function (queue) {
                    $.messager.progress({
                        title: '执行导入',
                        msg: '请等待...'
                    });
                },
                'onUploadComplete': function (file, data) {
                    $.messager.progress('close');
                    var data = $.parseJSON(data);
                    //console.log(data);
                    if (data.success == false) {
                        $.messager.alert('导入错误', '导入错误，请修改后再倒入！<br>' + data.message, 'error');
                        $("#file_upload").uploadifive('clearQueue')
                    } else {
                        $.messager.alert('导入完成', '导入完成！<br>', 'info');
                        $dg.datagrid('reload');
                        $('#importwindow').window('close');
                    }
                    return true;
                }
            });
            InitPageCombogrid("_FromCache");
            var FromData = "{}";
            var FormNAMEData = @Html.Raw(ViewData["FormNAME"] ?? "{}");
            FormNAMEData = $.extend(FromData,FormNAMEData);
            //设置ComboGrid真实url(为了不页面进入后 不立即加载数据，优化页面载入速度)
            //表单名称，虚拟url名称，是否刷新数据，ComboGrid-Text值
            resetCombogridUrl('div_search', null, false, {});
            var $a = $('<a href="javascript:void(0)" class="panel-tool-collapse"></a>');
            $a.bind("click",function(){
                var $div_cb = $("#div_collapsible","#div_search");
                if($div_cb.is(":hidden")){
                    $(this).removeClass("panel-tool-expand");
                    $div_cb.show();
                }
                else{
                    $(this).addClass("panel-tool-expand");
                    $div_cb.hide();
                }
            });
            $("#div_search").panel('panel').find("div.panel-header div.panel-tool").append($a);
        });
        //combogrig 初始化
        function InitPageCombogrid(_FromCache){
            var FromCache=""
            if(!(typeof(_FromCache) ==='undefined'||_FromCache ==null||_FromCache==''))
                FromCache = "_FromCache";
            //委托方
            $("#Entrustment_Name_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                textField: 'IDTEXT',
                url1:  '/CusBusInfos/GetPagerCusBusInfos'+FromCache
            }));
            //结算方
            $("#Carriage_Account_Code_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                textField: 'IDTEXT',
                url1:  '/CusBusInfos/GetPagerCusBusInfos'+FromCache
            }));
            //接单人
            $("#ADDWHO_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                idField:"UserName",
                valueField:"UserName",
                textField:'UserNameDesc',
                columns: [[
                    { field: 'UserName', title: '帐户', width: 70 },
                    { field: 'UserNameDesc', title: '名称', width: 150 }
                ]],
                url1: '/AccountManage/Get_PageUserList'+FromCache+'?IsJDServ=1'
            }));
            //目的港
            $("#End_Port_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                textField: 'IDTEXT',
                url1: '/PARA_AirPorts/GetPARA_AirPorts'+FromCache
            }));
            //代操作
            $("#Is_DCZ_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                mode: 'loacl',
                pagination: false,
                data:ArrUseStatus
            }));
            function Charge_CodeSleted(Selted){
                if (Selted) {
                    var NameVal = Selted["TEXT"];
                    if (!(typeof NameVal === 'undefined' || NameVal == null)) {
                        $("#Charge_Desc_Q").textbox('setValue',NameVal);
                    }else {
                        NameVal = Selted[$(this).combogrid('options').textField];
                        if (!(typeof NameVal === 'undefined' || NameVal == null))
                            $("#Charge_Desc_Q").textbox('setValue',NameVal);
                    }
                }
            }
            //费用代码
            var $Charge_Code = $('#Charge_Code_Q');
            if($Charge_Code.length>0){
                $Charge_Code.combogrid($.extend({},combogrid_DefaultSettings,{
                    textField:"ID",
                    url1: '/FeeTypes/GetPagerFeeTypes'+FromCache,
                    onChange: function () {
                        var Selted = $(this).combogrid('grid').datagrid('getSelected');
                        Charge_CodeSleted(Selted);
                    }
                }));
                //费用代码 keyup事件 小写转大写
                $Charge_Code.combogrid("textbox").bind('keyup',function(event){
                    var keyCode = event.which || event.keycode;
                    //console.log(keyCode);
                    if(keyCode!=229)
                        this.value = this.value.toUpperCase();
                });
            }
            //币种
            var $Money_Code = $('#Money_Code_Q');
            if($Money_Code.length>0){
                $Money_Code.combogrid($.extend({},combogrid_DefaultSettings,{
                    textField:"ID",
                    url1: '/PARA_CURRs/GetPagerPARA_CURR'+FromCache
                }));
                //费用代码 keyup事件 小写转大写
                $Money_Code.combogrid("textbox").bind('keyup',function(event){
                    var keyCode = event.which || event.keycode;
                    //console.log(keyCode);
                    if(keyCode!=229)
                        this.value = this.value.toUpperCase();
                });
            }
            //支付方式
            var $Payway =$('#Payway_Q');
            if($Payway.length>0){
                $Payway.combogrid($.extend({}, combogrid_DefaultSettings, {
                    textField:"Id",
                    url1: '/BD_DEFDOC_LISTS/GetPager_DEFDOC_DICT'+_FromCache+'?DOCCODE=PayWay'
                }));
                //支付方式 keyup事件 小写转大写
                $Payway.combogrid("textbox").bind('keyup',function(event){
                    var keyCode = event.which || event.keycode;
                    //console.log(keyCode);
                    if(keyCode!=229)//输入法占位符
                        this.value = this.value.toUpperCase();
                });
            }
            //账单类型
            var $Bill_Type =$('#Bill_Type_Q');
            if($Bill_Type.length>0){
                $Bill_Type.combogrid($.extend({}, combogrid_DefaultSettings, {
                    mode: 'loacl',
                    multiple:true,
                    pagination: false,
                    data:ArrBill_Type
                }));
                //账单类型 keyup事件 小写转大写
                $Bill_Type.combogrid("textbox").bind('keyup',function(event){
                    var keyCode = event.which || event.keycode;
                    //console.log(keyCode);
                    if(keyCode!=229)
                        this.value = this.value.toUpperCase();
                });
            }
            //制单人员
            $("#BillADDWHO_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                idField:"UserName",
                valueField:"UserName",
                textField:'UserNameDesc',
                columns: [[
                    { field: 'UserName', title: '帐户', width: 70 },
                    { field: 'UserNameDesc', title: '名称', width: 150 }
                ]],
                url1: '/AccountManage/Get_PageUserList'+FromCache
            }));
            //提交标志
            $("#Sumbmit_Status_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                mode: 'loacl',
                pagination: false,
                data:ArrUseStatus
            }));
            //提交人
            $("#Sumbmit_Name_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                idField:"Id",
                valueField:"Id",
                textField:'UserNameDesc',
                columns: [[
                    { field: 'UserName', title: '帐户', width: 70 },
                    { field: 'UserNameDesc', title: '名称', width: 150 }
                ]],
                url1: '/AccountManage/Get_PageUserList'+FromCache
            }));
            //审核标志
            $("#AuditStatus_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                mode: 'loacl',
                pagination: false,
                data:ArrAuditStatus
            }));
            //开票标志
            $("#Invoice_Status_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                mode: 'loacl',
                pagination: false,
                data:ArrUseStatus
            }));
            //签收标志
            $("#SignIn_Status_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                mode: 'loacl',
                pagination: false,
                data:ArrUseStatus
            }));
            //销账标志
            $("#SellAccount_Status_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                mode: 'loacl',
                pagination: false,
                data:ArrUseStatus
            }));
            //作废标志
            $("#Cancel_Status_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                mode: 'loacl',
                pagination: false,
                data:ArrUseStatus
            }));
            //销售
            $("#SallerId_Q").combogrid($.extend({}, combogrid_DefaultSettings, {
                columns: [[
                    { field: 'ID', title: 'ID', width: 30 },
                    { field: 'Code', title: '代码', width: 60 },
                    { field: 'TEXT', title: '名称', width: 120 },
                ]],
                url1: '/Sallers/GetPagerSallers'+FromCache
            }));
        }
        //导入
        function importexcel() {
            //获取datagrid
            if (!getCurrent$dg(this))
                return false;
            //$('#file_upload_mx').data('uploadifive').settings.formData = { 'dataLength': GetDataGrid_data($('#OrderDetail')).length };
            $('#importwindow').window('open');
        }
        //导出
        function exportexcel() {
            //获取datagrid
            if (!getCurrent$dg(this))
                return false;
            var opts = $dg.datagrid('options');

            var formData = { filterRules: opts.filterRules, sort: opts.sortName, order: opts.sortOrder };
            //var url = '/Bms_Bill_Aps/ExportExcel';
            var url = opts.url.replace('GetData', 'ExportExcel');
            $.DownLoadProgress({
                url: url,         //下载文件的url
                method: 'Post',   //链接打开方式
                data: formData,         //要发送的数据
                downLoadInfo: '下载文件', //下载界面文字
                closeDelay: 2000, //自动关闭时间(毫秒) 0则立马关闭
                callbackFuc: function () {
                    $.messager.progress('close');
                }
            });
        }

        //查询条件重置按钮 点击事件
        $("#btn-reset").click(function (e) {
            e.preventDefault();
            clearfrom();
        });
        //点击重置按钮时，触发，清空查询条件
        function clearfrom() {
            $('#searchform').form('clear');
        }
        $("#btn-search").click(function (e) {
            e.preventDefault();
            searchf();
            RemoveId=[];//重新 搜索 清空已移除的数据
            $dg.datagrid("clearChecked");
            $dg.datagrid("clearSelections");
        });
        //点击查询按钮时，触发
        function searchf() {
            var opts = $dg.datagrid('options');
            var params = setfilteropts();//设置查询条件
            window.LastSearch = params;
            ArrAddSearch =[];//清除 历史增加搜索
            opts.queryParams = {
                'filterRules': JSON.stringify(params)
            };
            opts.pageNumber = 1;
            var pager = $dg.datagrid('getPager');
            pager.pagination('refresh', {
                pageNumber: 1
            });
            $dg.datagrid('reload');
            //重新查询后清空统计金额
            var $dgPanel = $dg.datagrid('getPanel').parent();
            var $pheader = $dgPanel.find("div.panel-header");
            if($pheader.length>0){
                $pheader.remove();
            }
            $('#financetable div.datagrid-view2 div.datagrid-body').prop({ scrollLeft: 0, scrollTop: 0 });

        }
        //设置查询条件
        function setfilteropts() {
            var params = [];
            var searchData = getFormSerializeJson("#searchform");
            for(var i in searchData){
                var data = searchData[i];
                if (!(typeof (data) === 'undefined' || data == null || data == "")) {
                    params.push({ "field": i.replace('_Q',''), "op": "equal", "value": data });
                }
            }
            return params;
        }

        //datagrid  键盘事件(写在 jsext/EasyUIDataGrid_ControlNext 文件中)
        //var dg_keyHandler = dg_keyHandler;
        //datagrid 编辑时的 combogrid通用参数设置
        var dg_combo_coSettings = combogrid_DefaultSettings;
        //datagrid 编辑时的 combogrid参数设置
        var Arrcombogrid_Settings = {};
        Arrcombogrid_Settings = function setInitCombogridSettings(){
            var _Arrcombogrid_Settings ={};
            _Arrcombogrid_Settings[Curr$dgCtrl + '_datagrid'] = {
                'COUNTRY': $.extend({}, dg_combo_coSettings, {
                    required: true,
                    url: '/PARA_COUNTRYS/GetPagerPARA_COUNTRY',
                    idField: 'COUNTRY_CO',
                    valueField: 'COUNTRY_CO',
                    textField: 'COUNTRY_NA',
                    columns: [[
                        { field: 'COUNTRY_CO', title: '代码', width: 53 },
                        { field: 'COUNTRY_NA', title: '名称', width: 150 }
                    ]],
                    onChange: function (value) {
                        var targetEditor = $dg.datagrid('getEditor', {
                            field: 'COUNTRY',
                            index: editIndex
                        });
                        if (targetEditor != null) {
                            var Selted = $(targetEditor.target).combogrid('grid').datagrid('getSelected');
                            if (Selted) {
                                var datarow = $dg.datagrid('getData').rows[editIndex];
                                if (!(typeof datarow === 'undefined' || datarow == null)) {
                                    datarow['COUNTRY' + 'NAME'] = Selted[$(targetEditor.target).combogrid('options').textField];
                                }
                            }
                        }
                    }
                }),
                'Money_Code': $.extend({}, dg_combo_coSettings, {
                    required: true,
                    url: '/PARA_Currs/GetPARA_CURR_FromCache',
                }),
                'Org_Money_Code': $.extend({}, dg_combo_coSettings, {
                    required: true,
                    url: '/PARA_Currs/GetPARA_CURR_FromCache',
                }),
                'Bill_Object_Id': $.extend({}, dg_combo_coSettings, {
                    required: true,
                    url: '/CusBusInfos/GetCusBusInfos_FromCache',
                    onChange: function () {
                        //console.log(arguments);
                        var Selted = $(this).combogrid('grid').datagrid('getSelected');
                        if (Selted) {
                            var datarow = $dg.datagrid('getData').rows[editIndex];
                            if (!(typeof datarow === 'undefined' || datarow == null)) {
                                datarow["Bill_Object_Name"] = Selted[$(this).combogrid('options').textField];
                            }
                        }
                    }
                }),
                'Status':$.extend({}, dg_combo_coSettings, {
                    required: true,
                    mode:'local',
                    pagination: false,
                    data:ArrStatus
                }),
                'AuditStatus':$.extend({}, dg_combo_coSettings, {
                    required: true,
                    mode:'local',
                    pagination: false,
                    data:ArrAuditStatus
                }),
            };
            //明细
            _Arrcombogrid_Settings[Curr$dgCtrl + '_dtl_datagrid'] = {
                'Status':$.extend({}, dg_combo_coSettings, {
                    required: true,
                    mode:'local',
                    pagination: false,
                    data:ArrStatus
                }),
            };
            //bool状态
            var ArrboolCol = [
                /*应收/应付*/
                "Create_Status",//产生标志
                "Jk_Status",//集卡产生标志
                "Ishk_Status", //记录是否传入香港
                "Sbsx_Status",//实报实销状态
                "Dsdf_Status",//代收代付状态
                /*应收/应付-明细*/
                //"Create_Status",//产生标志
                "Invoice_Status",//开票标志
                "Chalk_Status",//签收标志
                "Collate_Status",//对帐标志
                "Refer_Status",//提交标志
                "Blank_Status",//销帐标志
                "Special_Status",//专项标志
                "Invos_Status",//开票后修改标志
            ];
            //设置combogrid-bool状态
            for(var i in _Arrcombogrid_Settings){
                for(var ii in ArrboolCol){
                    _Arrcombogrid_Settings[i][ArrboolCol[ii]] = $.extend({}, dg_combo_coSettings, {
                        required: true,
                        mode:'local',
                        pagination: false,
                        data:ArrUseStatus
                    });
                }
            }
            return _Arrcombogrid_Settings;
        }();

        //获取当前操作dg
        function getCurrent$dg(obj) {
            let type = typeof (obj);
            if (!(type === 'undefined' || obj === window || obj == null)) {
                let _$dg = $(obj).parent().siblings(".datagrid-view").children("table.easyui-datagrid");
                if (typeof (_$dg) === 'undefined' || _$dg == null || _$dg.length <= 0) {
                    if (typeof (editIndex) === 'undefined' || editIndex == null || editIndex < 0) {
                        $.messager.alert('提示', '无法找到datagrid或没有正在编辑的(' + editIndex + ')行！');
                        return false;
                    }
                } else
                    $dg = _$dg;
                return true;
            } else {
                $.messager.alert('提示', '无法找到datagrid！');
                return false;
            }
        }
        //开始编辑行时，赋值 联动数据
        function onBeginEdit(rowIndex, rowData) {
            $dg = $(this);
            var num = 0;
            var regx = /^\/Date\([0-9]+(\)\/)$/g;
            for (var i in rowData) {
                if (regx.test(rowData[i])) {
                    rowData[i] = datetimeformatter(rowData[i]);
                }
                var targetEditor = $dg.datagrid('getEditor', {
                    field: i,
                    index: rowIndex
                });
                //console.log("targetEditor", i, targetEditor);
                if (targetEditor) {
                    num++;
                    if (num == 1 && $(targetEditor.target).val() == '') {
                        $(targetEditor.target).parent().children("span:eq(0)").children("input:eq(0)").focus();
                    }

                    var OldVal = targetEditor.oldHtml;
                    switch (targetEditor.type.toLowerCase()) {
                        case "combogrid":
                            //console.log(targetEditor);
                            let combogrid_Setting = Arrcombogrid_Settings[$(this).attr('id')][targetEditor.field];
                            if (combogrid_Setting) {
                                //设置 combogrid 参数（回车下一个等）利用JS闭包原理，让js不回收变量
                                var fnGetcmgrid_Setting = function (_combogrid_Setting,field, _rowIndex) {
                                    return $.extend(combogrid_Setting, {
                                        onLoadSuccess: function (data) {
                                            ondgLoadSuccess($dg, field, _rowIndex);
                                        }
                                    }, dg_keyHandler);
                                };
                                $(targetEditor.target).combogrid(fnGetcmgrid_Setting(combogrid_Setting, targetEditor.field, rowIndex));
                                //设置Combogrid 分页控件 简单模式
                                SetCombogridPager(targetEditor.target);
                            }
                            if (!(typeof (OldVal) === 'undefined' || OldVal == null || OldVal == '')) {
                                if (rowData[targetEditor.field]) {
                                    OldVal = rowData[targetEditor.field];
                                }
                                $(targetEditor.target).combogrid('setValue', OldVal);
                                var opts = $(targetEditor.target).combogrid('options');
                                var url = opts.url;
                                //设置查询参数
                                var queryParams = {
                                    page: 1,
                                    rows: opts.pageSize,
                                    q: OldVal
                                };
                                $(targetEditor.target).combogrid('grid').datagrid('load', queryParams);
                            }
                            break;
                        case "combobox":
                            var opts = $(targetEditor.target).combobox({
                                inputEvents: $.extend({}, $.fn.combobox.defaults.inputEvents, {
                                    keydown: function (event) {
                                        combobox_keydown(this, event, $dg, rowIndex);
                                    }
                                })
                            });
                            setTargetVal(targetEditor, OldVal);
                            break;
                        case "textbox":
                        case "numberbox":
                        case "datebox":
                        case "datetimebox":
                            var data = $(targetEditor.target).data();
                            var $txtbox = $(data.textbox).find("input.textbox-text");
                            var $target = $(targetEditor.target);
                            $target.textbox({
                                inputEvents: $.extend({}, $.fn.textbox.defaults.inputEvents, {
                                    keydown: function (event) {
                                        dg_Listtextbox_keydown(this, event, $dg, rowIndex);
                                    }
                                })
                            });
                            setTargetVal(targetEditor, OldVal);
                            break;
                        case "checkbox":
                            $(targetEditor.target).keydown(function (e) {
                                chk_rdo_keydown(this, e, $dg, rowIndex);
                            });
                            setTargetVal(targetEditor, OldVal);
                            break;
                    }
                }
            }
        }
        //结算编辑
        function endEditing() {
            if (editIndex == undefined)
                return true;
            if ($dg.datagrid('validateRow', editIndex)) {
                $dg.datagrid('endEdit', editIndex);
                editIndex = undefined;
                return true;
            } else {
                return false;
            }
        }
        //选择行
        function onSelect(index, row) {
            $dg = $(this);
            //console.log(index, row);
        }
        function onCheckAll(){
            markAll = "ALL";
        }
        function onUncheckAll(){
            markAll = "";
        }
        //设置 不需要编辑的字段
        var Arr$dgNoEditorSet={};
        //设置 不需要编辑的字段
        var ColEditorNull = function(){
            return [
                "ADDWHO",
                "ADDTS",
                "Bill_Object_Name",//客户名称
                "AuditId",//审核人Id
                "Cancel_Id",//作废人Id
                "Chalk_Id",//签收人Id
                "Collate_Id",//对帐人Id
                "Invoice_Id",//发票人Id
                "Blank_Id",//销帐人Id
                "User_Id",//操作人员
            ];
        }();
        function Set$dgNoEditor(_$dg){
            var IsSet = false;//是否设置过
            var funcSet = function(_ColEditorNull){
                if(!IsSet){
                    for(var i in ColEditorNull){
                        var Column = _$dg.datagrid('getColumnOption', ColEditorNull[i]);
                        if (!(typeof (Column) === 'undefined' || Column == null || Column == '')) {
                            Column.editor = {};
                        }
                    }
                }
            };
            return {
                IsSet:IsSet,
                ColEditorNullColumn:ColEditorNull,
                Set:funcSet
            }
        }
        //双击行
        function onDblClickRow(index, row) {
            $dg = $(this);
            var Ops_M_OrdId = row.Ops_M_OrdId;
            var Ops_H_OrdId = row.Ops_H_OrdId;
            var IsAr = row.IsAr;//是否是应收账单
            if(!(typeof(Ops_M_OrdId)==='undefined'||Ops_M_OrdId==null||Ops_M_OrdId<=0))
                window.open('/Bms_Bill_Aps/BmsBillApView?OPS_M_OrdId='+Ops_M_OrdId);
            else if(!(typeof(Ops_H_OrdId)==='undefined'||Ops_H_OrdId==null||Ops_H_OrdId<=0))
                window.open('/Bms_Bill_Aps/BmsBillApView?OPS_H_OrdId='+Ops_H_OrdId);
            else
            {
                $.messager.alert('Warning', '数据格式错误，无法查看详细信息！');
                return false;
            }
        }
        //单机单元格
        function onClickCell(index, field) {
            $dg = $(this);
            var _operates = ["_operate1", "_operate2", "_operate3", "ck"]
            if ($.inArray(field, _operates) >= 0) {
                return;
            }
            if (editIndex != index) {
                if (endEditing()) {
                    if (!Editable)
                    {
                        $.messager.alert('提示', '您没有编辑权限！');
                        return false;
                    }
                    //动态设置 编辑样式
                    var O$dgNoEditorSet =Arr$dgNoEditorSet[$dg.attr('id')];
                    if(typeof(O$dgNoEditorSet)==='undefined'||O$dgNoEditorSet==null||O$dgNoEditorSet==''){
                        for(var i in ColEditorNull){
                            var Column = $dg.datagrid('getColumnOption', ColEditorNull[i]);
                            if (!(typeof (Column) === 'undefined' || Column == null || Column == '')) {
                                Column.editor = {};
                            }
                        }
                        Arr$dgNoEditorSet[$dg.attr('id')] = 1;
                    }

                    $dg.datagrid('selectRow', index).datagrid('beginEdit', index);
                    var ed = $dg.datagrid('getEditor', { index: index, field: field });
                    if (ed) {
                        ($(ed.target).data('textbox') ? $(ed.target).textbox('textbox') : $(ed.target)).focus();
                    }
                    editIndex = index;
                } else {
                    $dg.datagrid('selectRow', editIndex);
                }
            }
        }
        //加载成功
        function onLoadSuccess(rowdata) {
            //行号自适应宽度
            $(this).datagrid("fixRownumber");
            if($("#btnAddSearch").hasClass('active')){
                ResetSearch();//重置搜索
            }
        }
        //刷新
        function reload() {
            //获取datagrid
            if (!getCurrent$dg(this))
                return false;
            reject();//回滚所有变更
            $dg.datagrid('reload');
        }
        //新增
        function append() {
            //获取datagrid
            if (!getCurrent$dg(this))
                return false;
            AsyncGetMyWin('/OPS_M_Orders/GetSeltOPS_M_Ord?IsBmsBillAr=false','IsLoadSeltOPSMOrdWin','InitOPSMOrdWinFuc()',true);
            $("#win").window("open");
            return false;

            if (endEditing()) {
                var NewRow = {};
                var Columns = $dg.datagrid('getColumnFields');
                for (var column in Columns) {
                    NewRow[Columns[column]] = null;
                }
                NewRow['Status'] = 1;
                NewRow['AuditStatus'] = 1;
                //动态设置 编辑样式
                var byteColumn = $dg.datagrid('getColumnOption', 'ADDWHO');
                if (!(typeof (byteColumn) === 'undefined' || byteColumn == null || byteColumn == '')) {
                    byteColumn.editor = {
                        type: 'textbox',
                        options: {
                            required: false,
                            validType: 'length[0,20]'
                        }
                    };
                    byteColumn = $dg.datagrid('getColumnOption', 'ADDTS');
                    byteColumn.editor = {
                        type: 'datebox',
                        options: {
                            required: false
                        }
                    };
                    byteColumn = $dg.datagrid('getColumnOption', 'EDITWHO');
                    byteColumn.editor = {};
                    byteColumn = $dg.datagrid('getColumnOption', 'EDITTS');
                    byteColumn.editor = {};
                }
                $dg.datagrid('insertRow', { index: 0, row: NewRow });
                editIndex = 0;
                $dg.datagrid('selectRow', editIndex).datagrid('beginEdit', editIndex);
            }
        }
        //删除
        function removeit() {
            //获取datagrid
            if (!getCurrent$dg(this))
                return false;
            var Seltdata = $dg.datagrid('getChecked');
            //var Seltdata = $.extend({},$dg.datagrid('getSelections'),Chkeddata);
            //var Seltdata = $dg.datagrid('getSelections');
            if (!(typeof editIndex === 'undefined' || editIndex == null || isNaN(editIndex))) {
                $dg.datagrid('cancelEdit', editIndex);
                editIndex = undefined;
            }
            for (var i = Seltdata.length; i > 0; i--) {
                var rowindex = $dg.datagrid('getRowIndex', Seltdata[i - 1]);
                //console.log(rowindex);
                $dg.datagrid('deleteRow', rowindex);
            }
        }
        //保存
        function accept() {
            if(!(this ===window || typeof ($dg) === 'undefined' || $dg == null || $dg.length <= 0)){
                if(this !==window){
                    //获取datagrid
                    if(!getCurrent$dg(this))
                        return false;
                }
            }
            if (endEditing()) {
                if ($dg.datagrid('getChanges').length) {
                    var inserted = $dg.datagrid('getChanges', "inserted");
                    var deleted = $dg.datagrid('getChanges', "deleted");
                    var updated = $dg.datagrid('getChanges', "updated");
                    var effectRow = new Object();
                    if (inserted.length) {
                        effectRow.inserted = inserted;
                    }
                    if (deleted.length) {
                        effectRow.deleted = deleted;
                    }
                    if (updated.length) {
                        effectRow.updated = updated;
                    }
                    //console.log(JSON.stringify(effectRow));
                    //var url = '/Bms_Bill_Aps/SaveData';
                    var opts = $dg.datagrid('options');
                    var url = opts.url.replace('GetData', 'SaveData');
                    $.ajax({
                        type: 'POST',
                        url: url,//获取数据的函数
                        async: true,//true 异步，false 同步
                        dataType: "json",
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(effectRow),//查询条件JSON.stringify()
                        beforeSend: function (xhr) {//发送请求前运行的函数
                            $.messager.progress({
                                title: '数据处理中',
                                msg: '数据处理中，请等待...'
                            });
                            //验证重复提交时 请加上 这句
                            AddAjaxActionGuidName(this);
                        },
                        success: function (response) {//查询成功,data为返回的数据
                            if (response.Success) {
                                $.messager.alert("提示", "提交成功！");
                                $dg.datagrid('acceptChanges');
                                $dg.datagrid('reload');
                            }
                            else {
                                var ErrMsgStr = '提交错误了！';
                                if (!(typeof (response.ErrMsg) === 'undefined' || response.ErrMsg == null || response.ErrMsg == ''))
                                    ErrMsgStr = response.ErrMsg;
                                $.messager.alert("错误", ErrMsgStr, 'error');
                            }
                        },
                        error: function () {//查询失败
                            $.messager.alert("错误", "提交错误了！", 'error');
                        },
                        complete: function (xhr, status) {//请求完成时运行的函数（在请求成功或失败之后均调用，即在 success 和 error 函数之后）。
                            $.messager.progress('close');
                        }
                    });
                }
                //$dg.datagrid('acceptChanges');
            }
        }
        //取消（回滚所有数据变更）
        function reject() {
            if(!(this ===window || typeof ($dg) === 'undefined' || $dg == null || $dg.length <= 0)){
                if(this !==window){
                    //获取datagrid(this指向window时,不执行后面语句)
                    if(!getCurrent$dg(this))
                        return false;
                }
                $dg.datagrid('rejectChanges');
            }
            editIndex = undefined;
        }
        //获取 变更
        function getChanges() {
            var rows = $dg.datagrid('getChanges');
            alert(rows.length + ' rows are changed!');
        }
        //---------------------------------按钮 方法--------------------//
        //打开搜索
        function onBeforeCollapse_Search(){
            setTimeout(function(){
                var $div_cb = $("#div_collapsible","#div_search");
                if($div_cb.is(":hidden"))
                    $div_cb.slideDown(1000);
                else
                    $div_cb.slideUp(1000);
            },10);
            return false;
        }
        //关闭搜索
        function onBeforeExpand_Search(){
            return false;
        }
        //销毁弹出框
        function DestoryPoupWinFunc(){
            if(!(typeof(keydownEvent)==='undefined'||keydownEvent==null))
                $(document).unbind("keydown",keydownEvent);
            if($("#ArApEdit_PopupWin")){
                $("#ArApEdit_PopupWin").window("destroy").remove();
                $("#ArApEdit_PopupWin_js").remove();
                window.InitPopupEditWinFuc = function() {
                    //console.log('--------------InitPopupEditWinFuc---------------');
                };
            }
            if($("#ArApSubmit_PopupWin")){
                $("#ArApSubmit_PopupWin").window("destroy").remove();
                $("#ArApSubmit_PopupWin_js").remove();
                window.InitSubmitPopupWinFuc = function() {
                    //console.log('--------------InitSubmitPopupWinFuc---------------');
                };
            }
            if($("#ArApAddInvoice_PopupWin")){
                $("#ArApAddInvoice_PopupWin").window("destroy").remove();
                $("#ArApAddInvoice_PopupWin_js").remove();
                window.InitPopupAddInvoiceWinFuc = function() {
                    //console.log('--------------InitPopupAddInvoiceWinFuc---------------');
                };
            }
            if($("#ArApSignIn_PopupWin")){
                $("#ArApSignIn_PopupWin").window("destroy").remove();
                $("#ArApSignIn_PopupWin_js").remove();
                window.InitSignInPopupWinFuc = function() {
                    //console.log('--------------InitPopupAddInvoiceWinFuc---------------');
                };
            }
            if($("#ArApSellAccount_PopupWin")){
                $("#ArApSellAccount_PopupWin").window("destroy").remove();
                $("#ArApSellAccount_PopupWin_js").remove();
                window.InitSellAccount_PopupWinFuc = function() {
                    //console.log('--------------InitPopupAddInvoiceWinFuc---------------');
                };
            }
            if($("#ApValAddedTax_PopupWin")){
                $("#ApValAddedTax_PopupWin").window("destroy").remove();
                $("#ApValAddedTax_PopupWin_js").remove();
                window.InitApValAddedTax_PopupWinFuc = function() {
                    //console.log('--------------InitApValAddedTax_PopupWinFuc---------------');
                };
            }
        }
        //设置datagrid-头部内容
        function setdgHeader(_$dg,MsgStr){
            var $dgPanel = _$dg.datagrid('getPanel').parent();
            var $pheader = $dgPanel.find("div.panel-header");
            if($pheader.length<=0){
                $pheader = $('<div class="panel-header" style="border-left:0px;border-top:0px;"><div class="panel-title"></div><div class="panel-tool"></div></div>');
                $dgPanel.children(":first").prepend($pheader);
            }
            var $ptitle = $pheader.find('div.panel-title');
            var $ptool = $pheader.find('div.panel-tool');

            $pheader.css({width:$dgPanel.width()});
            $ptitle.html(MsgStr);
            $ptitle.css({height:"auto"});

            //opts.showFooter = true;
            //$dg.datagrid("reloadFooter",[{Dzbh:data.ErrMsg}]);
            //var rows = $dg.datagrid('getFooterRows');
            //$dg.datagrid('mergeCells', {
            //    index: 0,
            //    field: 'Dzbh',
            //    colspan: 5,
            //    type: 'footer'
            //});
            //var dgview = dgData.datagrid.panel.find("div.datagrid-view");
            //dgview.css({height:dgview.height()+37});
            //dgData.datagrid.dc.footer1.css({display:"block"}).find("tr:eq(0)").css({height:37});
            //dgData.datagrid.dc.footer2.css({display:"block"}).find("tr:eq(0)").css({height:37});
        }
        //------------------------ 报表 Start----------------------------//
        //数组排重
        //Array.prototype.distinct = function (){
        //    var arr = this,len = arr.length;
        //    arr.sort(function(a,b){  //对数组进行排序才能方便比较
        //        return a - b;
        //    });
        //    function loop(index){
        //        if(index >= 1){
        //            if(arr[index] === arr[index-1]){
        //                arr.splice(index,1);
        //            }
        //            loop(index - 1); //递归loop函数进行去重
        //        }
        //    }
        //    loop(len-1);
        //    return arr;
        //};

        //导出业务费用报销单
        function operationfee() {
            //if (!getCurrent$dg(this))
            //    return false;
            //$.messager.progress({
            //    text: '数据处理中......'
            //});
            var dgData =$dg.data();
            var opts = dgData.datagrid.options;
            var ArrRows = $dg.datagrid("getRows");             
            var ArrChecked = $dg.datagrid("getChecked");
            var ArrSignIn_Status = [];
            for(var i = 0;i < ArrChecked.length;i++){
                ArrSignIn_Status.push(ArrChecked[i].SignIn_Status);
            }
            var IS_SignIn_Status= ArrSignIn_Status.indexOf(false);
            var CheckedData = JSON.stringify(ArrChecked); 
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var formData = { ArrFinance:CheckedData, CheckALLstatus:CheckALLstatus, filterRules: opts.queryParams.filterRules, 'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: "业务费用报销单" };
            var ArrErr = [];
            if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
            {           
                $.messager.alert('提示',"查询数据为空！");
            } 
            else if(ArrChecked.length==0)
            {
                $.messager.alert('提示',"请选择账务信息！");                
            } 
            else if(IS_SignIn_Status != "-1")
            {
                $.messager.alert('提示',"已选中的账单未签收！");
            }                     
            else{
                var url = '/Finances/ExportOperationFee';
                $.ajax({
                    type: "POST",
                    datatype: "json",//接收的数据类型
                    //contentType: "application/json; charset=utf-8;",//告诉服务端 发送的数据类型
                    async: true,
                    data: formData,
                    url: url,
                    success: function (data) {
                        //$.messager.progress('close');
                        console.log(data);
                        if (data) {
                            if (data.Success == false) {
                                $.messager.alert('警告', data.ErrMsg);                                
                            } else{
                                window.open('/FileDownLoad/pdfDD/'+data)
                            }
                        }
                        else{
                            $.messager.alert('警告', '未知错误');
                        }
                    },
                    error: function () {
                        $.messager.progress('close');
                        $.messager.alert('警告', '数据处理中,出现网络错误');
                    }
                });
            }                      
        }
        //打印应付对账单
        function printbms_ap_account() {
            //if (!getCurrent$dg(this))
            //    return false;
            //$.messager.progress({
            //    text: '数据处理中......'
            //});
            var dgData =$dg.data();
            var rows = $dg.dategrid
            var opts = dgData.datagrid.options;
            var ArrRows = $dg.datagrid("getRows"); 
            var ArrChecked = $dg.datagrid("getChecked"); 
            var ArrBill_type=[];
            for(var i = 0;i<ArrChecked.length;i++)
            {
                ArrBill_type.push(ArrChecked[i].Bill_Type);
            }         
            var CheckedData = JSON.stringify(ArrChecked); 
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var formData = { ArrFinance:CheckedData, CheckALLstatus:CheckALLstatus, filterRules: opts.queryParams.filterRules, 'RemoveId':JSON.stringify(RemoveId),'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: "打印应付对账单" };
            if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
            {           
                $.messager.alert("提示","查询数据为空！");
            } 
            else if(ArrChecked.length==0)
            {
                $.messager.alert("提示","请选择账务信息！");
            }
            //else if(ArrBill_type.indexOf("C/N")=="-1" && ArrBill_type.indexOf("FTYF")=="-1")
            //{
            //    $.messager.alert("提示","选中的数据中没有应收信息！");
            //}  
            else{
                $.ajax({
                    type: "POST",
                    datatype: "json",//接收的数据类型
                    //contentType: "application/json; charset=utf-8;",//告诉服务端 发送的数据类型
                    async: true,
                    data: formData,
                    url: '/Finances/ExportBms_Ap_account',
                    success: function (data) {
                        //$.messager.progress('close');
                        console.log(data);
                        if (data) {
                            if (data.Success == false) {
                                $.messager.alert('警告', data.ErrMsg);                                
                            } else{
                                window.open('/FileDownLoad/pdfDD/'+data)
                            }
                        }
                        else{
                            $.messager.alert('警告', '未知错误');
                        }
                    },
                    error: function () {
                        $.messager.progress('close');
                        $.messager.alert('警告', '数据处理中,出现网络错误');
                    }
                });
            }               
        }
        //打印应收对账单
        function printbms_ar_account() {
            //if (!getCurrent$dg(this))
            //    return false;
            //$.messager.progress({
            //    text: '数据处理中......'
            //});
            var dgData =$dg.data();
            var rows = $dg.dategrid
            var opts = dgData.datagrid.options;
            var ArrRows = $dg.datagrid("getRows"); 
            var ArrChecked = $dg.datagrid("getChecked");
            var ArrBill_type=[];
            for(var i = 0;i<ArrChecked.length;i++)
            {
                ArrBill_type.push(ArrChecked[i].Bill_Type);
            }
            var CheckedData = JSON.stringify(ArrChecked); 
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var formData = { ArrFinance:CheckedData, CheckALLstatus:CheckALLstatus, filterRules: opts.queryParams.filterRules,'RemoveId':JSON.stringify(RemoveId), 'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: "打印应收对账单" };
            if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
            {           
                $.messager.alert("提示","查询数据为空！");
            }           
            else if(ArrChecked.length==0)
            {
                $.messager.alert("提示","请选择账务信息！");
            }
            //else if(ArrBill_type.indexOf("D/N")=="-1" && ArrBill_type.indexOf("FP")=="-1")
            //{
            //    $.messager.alert("提示","选中的数据中没有应收信息！");
            //}     
            else{
                $.ajax({
                    type: "POST",
                    datatype: "json",//接收的数据类型
                    //contentType: "application/json; charset=utf-8;",//告诉服务端 发送的数据类型
                    async: true,
                    data: formData,
                    url: '/Finances/ExportBms_Ar_account',
                    success: function (data) {
                        //$.messager.progress('close');
                        //console.log(data);
                        if (data) {
                            if (data.Success == false) {
                                $.messager.alert('警告', data.ErrMsg);                                
                            } else{
                                window.open('/FileDownLoad/pdfDD/'+data)
                            }
                        }
                        else{
                            $.messager.alert('警告', '未知错误');
                        }
                    },
                    error: function () {
                        $.messager.progress('close');
                        $.messager.alert('警告', '数据处理中,出现网络错误');
                    }
                });
            }               
        }
        //打印应付对账单（含税）
        function printbms_ap_account_HasTax() {
            //if (!getCurrent$dg(this))
            //    return false;
            //$.messager.progress({
            //    text: '数据处理中......'
            //});
            var dgData =$dg.data();
            var rows = $dg.dategrid
            var opts = dgData.datagrid.options;
            var ArrRows = $dg.datagrid("getRows"); 
            var ArrChecked = $dg.datagrid("getChecked");
            var ArrBill_type=[];
            for(var i = 0;i<ArrChecked.length;i++)
            {
                ArrBill_type.push(ArrChecked[i].Bill_Type);
            }
            var CheckedData = JSON.stringify(ArrChecked); 
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var formData = { ArrFinance:CheckedData, CheckALLstatus:CheckALLstatus, filterRules: opts.queryParams.filterRules, 'RemoveId':JSON.stringify(RemoveId),'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: "打印应付对账单(含税)" };
            if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
            {           
                $.messager.alert("提示","查询数据为空！");
            }            
            else if(ArrChecked.length==0)
            {
                $.messager.alert("提示","请选择账务信息！");
            }
            //else if(ArrBill_type.indexOf("C/N")=="-1" && ArrBill_type.indexOf("FTYF")=="-1")
            //{
            //    $.messager.alert("提示","选中的数据中没有应收信息！");
            //}  
            else{
                $.ajax({
                    type: "POST",
                    datatype: "json",//接收的数据类型
                    //contentType: "application/json; charset=utf-8;",//告诉服务端 发送的数据类型
                    async: true,
                    data: formData,
                    url: '/Finances/ExportBms_Ap_account_HasTax',
                    success: function (data) {
                        //$.messager.progress('close');
                        console.log(data);
                        if (data) {
                            if (data.Success == false) {
                                $.messager.alert('警告', data.ErrMsg);                                
                            } else{
                                window.open('/FileDownLoad/pdfDD/'+data)
                            }
                        }
                        else{
                            $.messager.alert('警告', '未知错误');
                        }
                    },
                    error: function () {
                        $.messager.progress('close');
                        $.messager.alert('警告', '数据处理中,出现网络错误');
                    }
                });
            }               
        }
        //打印应收对账单（含税）
        function printbms_ar_account_HasTax() {
            //if (!getCurrent$dg(this))
            //    return false;
            //$.messager.progress({
            //    text: '数据处理中......'
            //});
            var dgData =$dg.data();
            var rows = $dg.dategrid
            var opts = dgData.datagrid.options;
            var ArrRows = $dg.datagrid("getRows"); 
            var ArrChecked = $dg.datagrid("getChecked");
            var ArrBill_type=[];
            for(var i = 0;i<ArrChecked.length;i++)
            {
                ArrBill_type.push(ArrChecked[i].Bill_Type);
            }
            var CheckedData = JSON.stringify(ArrChecked); 
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var formData = { ArrFinance:CheckedData, CheckALLstatus:CheckALLstatus, filterRules: opts.queryParams.filterRules, 'RemoveId':JSON.stringify(RemoveId),'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: "打印应收对账单(含税)" };
            if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
            {           
                $.messager.alert("提示","查询数据为空！");
            }           
            else if(ArrChecked.length==0)
            {
                $.messager.alert("提示","请选择账务信息！");
            }
            //else if(ArrBill_type.indexOf("D/N")=="-1" && ArrBill_type.indexOf("FP")=="-1")
            //{
            //    $.messager.alert("提示","选中的数据中没有应收信息！");
            //}     
            else{
                $.ajax({
                    type: "POST",
                    datatype: "json",//接收的数据类型
                    //contentType: "application/json; charset=utf-8;",//告诉服务端 发送的数据类型
                    async: true,
                    data: formData,
                    url: '/Finances/ExportBms_Ar_account_HasTax',
                    success: function (data) {
                        //$.messager.progress('close');
                        //console.log(data);
                        if (data) {
                            if (data.Success == false) {
                                $.messager.alert('警告', data.ErrMsg);                                
                            } else{
                                window.open('/FileDownLoad/pdfDD/'+data)
                            }
                        }
                        else{
                            $.messager.alert('警告', '未知错误');
                        }
                    },
                    error: function () {
                        $.messager.progress('close');
                        $.messager.alert('警告', '数据处理中,出现网络错误');
                    }
                });
            }               
        }
        //导出应付对账单Excel
        function exportbms_ap_account() {
            //if (!getCurrent$dg(this))
            //    return false;
            //$.messager.progress({
            //    text: '数据处理中......'
            //});
            var dgData =$dg.data();
            var opts = dgData.datagrid.options;
            var ArrRows = $dg.datagrid("getRows");             
            var ArrChecked = $dg.datagrid("getChecked");
            var ArrBill_type=[];
            for(var i = 0;i<ArrChecked.length;i++)
            {
                ArrBill_type.push(ArrChecked[i].Bill_Type);
            }
            var CheckedData = JSON.stringify(ArrChecked); 
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var formData = { ArrFinance:CheckedData, CheckALLstatus:CheckALLstatus, filterRules: opts.queryParams.filterRules,'RemoveId':JSON.stringify(RemoveId), 'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: "应付对账单" };
            if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
            {           
                $.messager.alert("提示","查询数据为空！");
            } 
            else if(ArrChecked.length==0)
            {
                $.messager.alert("提示","请选择账务信息！");
            }   
            //else if(ArrBill_type.indexOf("C/N")=="-1" && ArrBill_type.indexOf("FTYF")=="-1")
            //{
            //    $.messager.alert("提示","选中的数据中没有应收信息！");
            //}          
            else{
                var url = '/Finances/ExportBms_Ap_account';
                $.DownLoadProgress({
                    url: url,         //下载文件的url
                    method: 'Post',   //链接打开方式
                    data: formData,         //要发送的数据
                    downLoadInfo: '下载文件', //下载界面文字
                    closeDelay: 2000, //自动关闭时间(毫秒) 0则立马关闭
                    callbackFuc: function (data) {
                        if(typeof(data)=="string"){
                            data = JSON.parse(data);                                        
                            if(!data.Success)
                            {
                                $.messager.alert("提示",data.ErrMsg);
                            }
                            $.messager.progress('close');
                        }else{
                            $.messager.progress('close');
                        }
                        //reload();
                    }
                });
            }                      
        }
        //导出应付对账单Excel（含税）
        function exportbms_ap_account_HasTax() {
            //if (!getCurrent$dg(this))
            //    return false;
            //$.messager.progress({
            //    text: '数据处理中......'
            //});
            var dgData =$dg.data();
            var opts = dgData.datagrid.options;
            var ArrRows = $dg.datagrid("getRows"); 
            var ArrChecked = $dg.datagrid("getChecked");
            var ArrBill_type=[];
            for(var i = 0;i<ArrChecked.length;i++)
            {
                ArrBill_type.push(ArrChecked[i].Bill_Type);
            }
            var CheckedData = JSON.stringify(ArrChecked); 
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var formData = { ArrFinance:CheckedData, CheckALLstatus:CheckALLstatus, filterRules: opts.queryParams.filterRules, 'RemoveId':JSON.stringify(RemoveId),'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: "应付对账单(含税)" };
            if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
            {           
                $.messager.alert("提示","查询数据为空！");
            }  
            else if(ArrChecked.length==0)
            {
                $.messager.alert("提示","请选择账务信息！");
            }  
            //else if(ArrBill_type.indexOf("C/N")=="-1" && ArrBill_type.indexOf("FTYF")=="-1")
            //{
            //    $.messager.alert("提示","选中的数据中没有应收信息！");
            //}        
            else{
                var url = '/Finances/ExportBms_Ap_account_HasTax';
                $.DownLoadProgress({
                    url: url,         //下载文件的url
                    method: 'Post',   //链接打开方式
                    data: formData,         //要发送的数据
                    downLoadInfo: '下载文件', //下载界面文字
                    closeDelay: 2000, //自动关闭时间(毫秒) 0则立马关闭
                    callbackFuc: function (data) {
                        if(typeof(data)=="string"){
                            data = JSON.parse(data);                                        
                            if(!data.Success)
                            {
                                $.messager.alert("提示",data.ErrMsg);
                            }
                            $.messager.progress('close');
                        }else{
                            $.messager.progress('close');
                        }
                        //reload();
                    }
                });
            }                      
        }
        //导出应收对账单Excel
        function exportbms_ar_account() {
            //if (!getCurrent$dg(this))
            //    return false;
            //$.messager.progress({
            //    text: '数据处理中......'
            //});
            var dgData =$dg.data();
            var opts = dgData.datagrid.options;
            var ArrRows = $dg.datagrid("getRows"); 
            var ArrChecked = $dg.datagrid("getChecked");
            var ArrBill_type=[];
            for(var i = 0;i<ArrChecked.length;i++)
            {
                ArrBill_type.push(ArrChecked[i].Bill_Type);
            }
            var CheckedData = JSON.stringify(ArrChecked); 
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var formData = { ArrFinance:CheckedData, CheckALLstatus:CheckALLstatus, filterRules: opts.queryParams.filterRules, 'RemoveId':JSON.stringify(RemoveId),'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: "应收对账单" };
            if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
            {           
                $.messager.alert("提示","查询数据为空！");
            }  
            else if(ArrChecked.length==0)
            {
                $.messager.alert("提示","请选择账务信息！");
            }
            //else if(ArrBill_type.indexOf("D/N")=="-1" && ArrBill_type.indexOf("FP")=="-1")
            //{
            //    $.messager.alert("提示","选中的数据中没有应收信息！");
            //}           
            else{
                var url = '/Finances/ExportBms_Ar_account';
                $.DownLoadProgress({
                    url: url,         //下载文件的url
                    method: 'Post',   //链接打开方式
                    data: formData,         //要发送的数据
                    downLoadInfo: '下载文件', //下载界面文字
                    closeDelay: 2000, //自动关闭时间(毫秒) 0则立马关闭
                    callbackFuc: function (data) {
                        if(typeof(data)=="string"){
                            data = JSON.parse(data);                                        
                            if(!data.Success)
                            {
                                $.messager.alert("提示",data.ErrMsg);
                            }
                            $.messager.progress('close');
                        }else{
                            $.messager.progress('close');
                        }
                        //reload();
                    }
                });
            }                      
        }
        //导出应收对账单Excel（含税）
        function exportbms_ar_account_HasTax() {
            //if (!getCurrent$dg(this))
            //    return false;
            //$.messager.progress({
            //    text: '数据处理中......'
            //});
            var dgData =$dg.data();
            var opts = dgData.datagrid.options;
            var ArrRows = $dg.datagrid("getRows"); 
            var ArrChecked = $dg.datagrid("getChecked");
            var ArrBill_type=[];
            for(var i = 0;i<ArrChecked.length;i++)
            {
                ArrBill_type.push(ArrChecked[i].Bill_Type);
            }
            var CheckedData = JSON.stringify(ArrChecked); 
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var formData = { ArrFinance:CheckedData, CheckALLstatus:CheckALLstatus, filterRules: opts.queryParams.filterRules, 'RemoveId':JSON.stringify(RemoveId),'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: "应收对账单(含税)" };
            if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
            {           
                $.messager.alert("提示","查询数据为空！");
            }  
            else if(ArrChecked.length==0)
            {
                $.messager.alert("提示","请选择账务信息！");
            }    
            //else if(ArrBill_type.indexOf("D/N")=="-1" && ArrBill_type.indexOf("FP")=="-1")
            //{
            //    $.messager.alert("提示","选中的数据中没有应收信息！");
            //}       
            else{
                var url = '/Finances/ExportBms_Ar_account_HasTax';
                $.DownLoadProgress({
                    url: '/Finances/ExportBms_Ar_account_HasTax',         //下载文件的url
                    method: 'Post',   //链接打开方式
                    data: formData,         //要发送的数据
                    downLoadInfo: '下载文件', //下载界面文字
                    closeDelay: 2000, //自动关闭时间(毫秒) 0则立马关闭
                    callbackFuc: function (data) {
                        if(typeof(data)=="string"){
                            data = JSON.parse(data);                                        
                            if(!data.Success)
                            {
                                $.messager.alert("提示",data.ErrMsg);
                            }
                            $.messager.progress('close');
                        }else{
                            $.messager.progress('close');
                        }
                        //reload();
                    }
                });
            }                      
        }
        //导出应付明细
        function exportbms_ap_fee() 
        {
            var dgData =$dg.data();
            var opts = dgData.datagrid.options;
            var ArrRows = $dg.datagrid("getRows");
            var ArrChecked = $dg.datagrid("getChecked");
            var CheckedData = JSON.stringify(ArrChecked); 
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var formData = { ArrFinance:CheckedData, CheckALLstatus:CheckALLstatus, filterRules: opts.queryParams.filterRules, 'RemoveId':JSON.stringify(RemoveId),'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: "应付明细" };
            //console.log(opts.queryParams.filterRules);
            if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
            {           
                $.messager.alert("提示","查询数据为空！");
            } 
            else if(ArrChecked.length==0)
            {
                $.messager.alert("提示","请选择账务信息！");
            }
            else{
                var url = '/Finances/ExportBms_Ap_Fee';
                $.DownLoadProgress({
                    url: url,         //下载文件的url
                    method: 'Post',   //链接打开方式
                    data: formData,         //要发送的数据
                    downLoadInfo: '下载文件', //下载界面文字
                    closeDelay: 2000, //自动关闭时间(毫秒) 0则立马关闭
                    callbackFuc: function (data) {
                        if(typeof(data)=="string"){
                            data = JSON.parse(data);                                        
                            if(!data.Success)
                            {
                                $.messager.alert("提示",data.ErrMsg);
                            }
                            $.messager.progress('close');
                        }else{
                            $.messager.progress('close');
                        }
                        //reload();
                    }
                });
            }                      
        }  
        //导出应收明细
        function exportbms_ar_fee() 
        {
            var dgData =$dg.data();
            var opts = dgData.datagrid.options;
            var ArrRows = $dg.datagrid("getRows");
            var ArrChecked = $dg.datagrid("getChecked");
            var CheckedData = JSON.stringify(ArrChecked); 
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var formData = { ArrFinance:CheckedData, CheckALLstatus:CheckALLstatus, filterRules: opts.queryParams.filterRules, 'RemoveId':JSON.stringify(RemoveId),'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: "应收明细" };
            //console.log(opts.queryParams.filterRules);
            if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
            {           
                $.messager.alert("提示","查询数据为空！");
            } 
            else if(ArrChecked.length==0)
            {
                $.messager.alert("提示","请选择账务信息！");
            }
            else{
                var url = '/Finances/ExportBms_Ar_Fee';
                $.DownLoadProgress({
                    url: url,         //下载文件的url
                    method: 'Post',   //链接打开方式
                    data: formData,         //要发送的数据
                    downLoadInfo: '下载文件', //下载界面文字
                    closeDelay: 2000, //自动关闭时间(毫秒) 0则立马关闭
                    callbackFuc: function (data) {
                        if(typeof(data)=="string"){
                            data = JSON.parse(data);                                        
                            if(!data.Success)
                            {
                                $.messager.alert("提示",data.ErrMsg);
                            }
                            $.messager.progress('close');
                        }else{
                            $.messager.progress('close');
                        }
                        //reload();
                    }
                });
            }                      
        }
        //导出应付费用明细
        function exportbms_ap_fee_dtl() 
        {
            var dgData =$dg.data();
            var opts = dgData.datagrid.options;
            var ArrRows = $dg.datagrid("getRows");
            var ArrChecked = $dg.datagrid("getChecked");
            var CheckedData = JSON.stringify(ArrChecked); 
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var formData = { ArrFinance:CheckedData, CheckALLstatus:CheckALLstatus, filterRules: opts.queryParams.filterRules, 'RemoveId':JSON.stringify(RemoveId),'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: "应付费用明细" };
            //console.log(opts.queryParams.filterRules);
            if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
            {           
                $.messager.alert("提示","查询数据为空！");
            } 
            else if(ArrChecked.length==0)
            {
                $.messager.alert("提示","请选择账务信息！");
            }
            else{
                var url = '/Finances/ExportBms_Ap_Fee_Dtl';
                $.DownLoadProgress({
                    url: url,         //下载文件的url
                    method: 'Post',   //链接打开方式
                    data: formData,         //要发送的数据
                    downLoadInfo: '下载文件', //下载界面文字
                    closeDelay: 2000, //自动关闭时间(毫秒) 0则立马关闭
                    callbackFuc: function (data) {
                        if(typeof(data)=="string"){
                            data = JSON.parse(data);                                        
                            if(!data.Success)
                            {
                                $.messager.alert("提示",data.ErrMsg);
                            }
                            $.messager.progress('close');
                        }else{
                            $.messager.progress('close');
                        }
                        //reload();
                    }
                });
            }                      
        } 
        //导出应收费用明细
        function exportbms_ar_fee_dtl() 
        {
            var dgData =$dg.data();
            var opts = dgData.datagrid.options;
            var ArrRows = $dg.datagrid("getRows");
            var ArrChecked = $dg.datagrid("getChecked");
            var CheckedData = JSON.stringify(ArrChecked); 
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var formData = { ArrFinance:CheckedData, CheckALLstatus:CheckALLstatus, filterRules: opts.queryParams.filterRules, 'RemoveId':JSON.stringify(RemoveId),'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: "应收费用明细" };
            //console.log(opts.queryParams.filterRules);
            if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
            {           
                $.messager.alert("提示","查询数据为空！");
            } 
            else if(ArrChecked.length==0)
            {
                $.messager.alert("提示","请选择账务信息！");
            }
            else{
                var url = '/Finances/ExportBms_Ar_Fee_Dtl';
                $.DownLoadProgress({
                    url: url,         //下载文件的url
                    method: 'Post',   //链接打开方式
                    data: formData,         //要发送的数据
                    downLoadInfo: '下载文件', //下载界面文字
                    closeDelay: 2000, //自动关闭时间(毫秒) 0则立马关闭
                    callbackFuc: function (data) {
                        if(typeof(data)=="string"){
                            data = JSON.parse(data);                                        
                            if(!data.Success)
                            {
                                $.messager.alert("提示",data.ErrMsg);
                            }
                            $.messager.progress('close');
                        }else{
                            $.messager.progress('close');
                        }
                        //reload();
                    }
                });
            }                      
        } 
        //导出结算方应收明细
        function exportAR_For_Settle(typeName) 
        {
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var ArrChecked = $dg.datagrid("getChecked");
            if (ArrChecked.length == 0) {
                $.messager.alert("提示", "请选择接单数据！");
            }else {
                var CheckedData = JSON.stringify(ArrChecked);
                var dgData =$dg.data();
                var opts = dgData.datagrid.options;
                var ArrRows = $dg.datagrid("getRows");
                var formData = { filterRules: opts.queryParams.filterRules,'RemoveId':JSON.stringify(RemoveId), 'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: typeName, filterArr:CheckedData,  IsAr: true,CheckALLstatus : CheckALLstatus};
                //console.log(opts.queryParams.filterRules);
                if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
                {           
                    $.messager.alert("提示","查询数据为空！");
                } 
                else{
                    var url = '/Finances/ExportAR_For_Settle';
                    $.DownLoadProgress({
                        url: url,         //下载文件的url
                        method: 'Post',   //链接打开方式
                        data: formData,         //要发送的数据
                        downLoadInfo: '下载文件', //下载界面文字
                        closeDelay: 2000, //自动关闭时间(毫秒) 0则立马关闭
                        callbackFuc: function (data) {
                            if(typeof(data)=="string"){
                                data = JSON.parse(data);                                        
                                if(!data.Success)
                                {
                                    $.messager.alert("提示",data.ErrMsg);
                                }
                                $.messager.progress('close');
                            }else{
                                $.messager.progress('close');
                            }
                            //reload();
                        }
                    });
                }
            }
        } 
        //导出结算方应付明细
        function exportAP_For_Settle(value) 
        {
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var ArrChecked = $dg.datagrid("getChecked");
            if (ArrChecked.length == 0) {
                $.messager.alert("提示", "请选择接单数据！");
            }else {
                var CheckedData = JSON.stringify(ArrChecked);
                var dgData =$dg.data();
                var opts = dgData.datagrid.options;
                var ArrRows = $dg.datagrid("getRows");
                var formData = { filterRules: opts.queryParams.filterRules, 'RemoveId':JSON.stringify(RemoveId),'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: value, filterArr:CheckedData,  IsAr: false,CheckALLstatus : CheckALLstatus};
                //console.log(opts.queryParams.filterRules);
                if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
                {           
                    $.messager.alert("提示","查询数据为空！");
                } 
                else{
                    var url = '/Finances/ExportAR_For_Settle';
                    $.DownLoadProgress({
                        url: url,         //下载文件的url
                        method: 'Post',   //链接打开方式
                        data: formData,         //要发送的数据
                        downLoadInfo: '下载文件', //下载界面文字
                        closeDelay: 2000, //自动关闭时间(毫秒) 0则立马关闭
                        callbackFuc: function (data) {
                            if(typeof(data)=="string"){
                                data = JSON.parse(data);                                        
                                if(!data.Success)
                                {
                                    $.messager.alert("提示",data.ErrMsg);
                                }
                                $.messager.progress('close');
                            }else{
                                $.messager.progress('close');
                            }
                            //reload();
                        }
                    });
                }
            }   
        } 
        //打印结算方应收明细
        function exportPDFAR_For_Settle(typeName) 
        {
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var ArrChecked = $dg.datagrid("getChecked");
            if (ArrChecked.length == 0) {
                $.messager.alert("提示", "请选择接单数据！");
            }else {
                var CheckedData = JSON.stringify(ArrChecked);
                var dgData =$dg.data();
                var opts = dgData.datagrid.options;
                var ArrRows = $dg.datagrid("getRows");
                var CheckedData = JSON.stringify(ArrChecked); 
                var formData = { filterRules: opts.queryParams.filterRules, 'RemoveId':JSON.stringify(RemoveId),'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: typeName, filterArr:CheckedData,  IsAr: true,CheckALLstatus : CheckALLstatus};
                //console.log(opts.queryParams.filterRules);
                if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
                {           
                    $.messager.alert("提示","查询数据为空！");
                } 
                else{
                    var url = '/Finances/ExportAR_For_Settle';
                    $.ajax({
                        type: "POST",
                        datatype: "json",//接收的数据类型
                        //contentType: "application/json; charset=utf-8;",//告诉服务端 发送的数据类型
                        async: true,
                        data: formData,
                        url: url,
                        success: function (data) {
                            //$.messager.progress('close');
                            console.log(data);
                            if (data) {
                                if (data.Success == false) {
                                    $.messager.alert('警告', data.ErrMsg);                                
                                } else{
                                    if(data.indexOf(".pdf") != -1){
                                        window.open('/FileDownLoad/pdfDD/'+data)
                                    }
                                }
                            }
                            else{
                                $.messager.alert('警告', '未知错误');
                            }
                        },
                        error: function () {
                            $.messager.progress('close');
                            $.messager.alert('警告', '数据处理中,出现网络错误');
                        }
                    });
                }
            }
        } 
        //打印结算方应付明细
        function exportPDFAP_For_Settle(value) 
        {
            var CheckALLstatus = $dg.parent().find("div .datagrid-header-check").children("input[type=\"checkbox\"]").eq(0).is(':checked');
            var ArrChecked = $dg.datagrid("getChecked");
            if (ArrChecked.length == 0) {
                $.messager.alert("提示", "请选择接单数据！");
            }else {
                var CheckedData = JSON.stringify(ArrChecked);
                var dgData =$dg.data();
                var opts = dgData.datagrid.options;
                var ArrRows = $dg.datagrid("getRows");
                var formData = { filterRules: opts.queryParams.filterRules,'RemoveId':JSON.stringify(RemoveId), 'AddfilterRules': JSON.stringify(ArrAddSearch),sort: opts.sortName, order: opts.sortOrder, typeName: value, filterArr:CheckedData,  IsAr: false,CheckALLstatus : CheckALLstatus};
                //console.log(opts.queryParams.filterRules);
                if(opts.queryParams.filterRules=="undefined"||opts.queryParams.filterRules==null || ArrRows.length==0)
                {           
                    $.messager.alert("提示","查询数据为空！");
                } 
                else{
                    var url = '/Finances/ExportAR_For_Settle';
                    $.ajax({
                        type: "POST",
                        datatype: "json",//接收的数据类型
                        //contentType: "application/json; charset=utf-8;",//告诉服务端 发送的数据类型
                        async: true,
                        data: formData,
                        url: url,
                        success: function (data) {
                            //$.messager.progress('close');
                            console.log(data);
                            if (data) {
                                if (data.Success == false) {
                                    $.messager.alert('警告', data.ErrMsg);                                
                                } else{
                                    if(data.indexOf(".pdf") != -1){
                                        window.open('/FileDownLoad/pdfDD/'+data)
                                    }
                                }
                            }
                            else{
                                $.messager.alert('警告', '未知错误');
                            }
                        },
                        error: function () {
                            $.messager.progress('close');
                            $.messager.alert('警告', '数据处理中,出现网络错误');
                        }
                    });
                }
            }   
        } 
        //导出报表 快捷菜单，各个子菜单的 单击事件
        $('#BMS_Export').menu({
            onClick: function (item) {
                switch (item.text) {
                    case "应付对账单":
                        exportbms_ap_account();
                        break;
                    case "应收对账单":
                        exportbms_ar_account();
                        break;
                    case "应付对账单(含税)":
                        exportbms_ap_account_HasTax();
                        break;
                    case "应收对账单(含税)":
                        exportbms_ar_account_HasTax();
                        break;
                    case "应付明细":
                        exportbms_ap_fee()
                        break;
                    case "应收明细":
                        exportbms_ar_fee();
                        break;
                    case "应付费用明细":
                        exportbms_ap_fee_dtl();
                        break;
                    case "应收费用明细":
                        exportbms_ar_fee_dtl();
                        break;
                    case "结算方应付明细":
                        exportAP_For_Settle("结算方应付明细");
                        break;
                    case "结算方应收明细":
                        exportAR_For_Settle("结算方应收明细");
                        break;
                }
            }
        });
        //打印报表 快捷菜单，各个子菜单的 单击事件
        $('#BMS_Print').menu({
            onClick: function (item) {
                switch (item.text) {
                    case "应付对账单":
                        printbms_ap_account();
                        break;
                    case "应收对账单":
                        printbms_ar_account();
                        break;
                    case "应付对账单(含税)":
                        printbms_ap_account_HasTax();
                        break;
                    case "应收对账单(含税)":
                        printbms_ar_account_HasTax();
                        break;
                    case "结算方应付明细":
                        exportPDFAP_For_Settle("打印结算方应付明细");
                        break;
                    case "结算方应收明细":
                        exportPDFAR_For_Settle("打印结算方应收明细");
                        break;
                    case "业务费用报销单":
                        operationfee();
                        break;
                }
            }
        });
        //------------------------ 报表 End----------------------------//
        //金额汇总
        function AmountToatal(){
            //获取datagrid
            if (!getCurrent$dg(this))
                return false;
            $.messager.progress({
                text: '数据处理中......'
            });
            var url = "/Finances/AmountToatal";
            var dgData =$dg.data();
            var opts = dgData.datagrid.options;
            $.ajax({
                type: "POST",
                datatype: "json",//接收的数据类型
                //contentType: "application/json; charset=utf-8;",//告诉服务端 发送的数据类型
                async: true,
                data: {
                    "filterRules": opts.queryParams.filterRules,
                    'AddfilterRules': JSON.stringify(ArrAddSearch),
                    'RemoveId':JSON.stringify(RemoveId)
                },
                url: url,
                success: function (data) {
                    $.messager.progress('close');
                    if (data) {
                        if (data.Success) {
                            setdgHeader($dg,data.ErrMsg);//设置datagrid-头部内容
                        } else{
                            $.messager.alert('警告', data.ErrMsg);
                        }
                    }
                    else{
                        $.messager.alert('警告', '未知错误');
                    }
                },
                error: function () {
                    $.messager.progress('close');
                    $.messager.alert('警告', '数据处理中,出现网络错误');
                }
            });
        }
        //统计选中金额汇总
        function AmountTotalSelted(){
            var ArrChecked = $dg.datagrid("getChecked");          
            if(typeof ArrChecked==='undefined'||ArrChecked == null||ArrChecked.length<1){
                $.messager.alert("警告","至少需要选中一条数据，才能统计");
                return false;
            }else{
                ArrChecked = ArrChecked.map(function(item){
                    var dateVal = item["Bill_Date"];
                    if(!(typeof(dateVal)==='undefined'||dateVal==null||dateVal==''))
                        item["Bill_Date"] = moment(dateVal);
                    dateVal = item["Sumbmit_Date"];
                    if(!(typeof(dateVal)==='undefined'||dateVal==null||dateVal==''))
                        item["Sumbmit_Date"] = moment(dateVal);
                    dateVal = item["Invoice_Date"];
                    if(!(typeof(dateVal)==='undefined'||dateVal==null||dateVal==''))
                        item["Invoice_Date"] =  moment(dateVal);
                    dateVal = item["SellAccount_Date"];
                    if(!(typeof(dateVal)==='undefined'||dateVal==null||dateVal==''))
                        item["SellAccount_Date"] =  moment(dateVal);
                    dateVal = item["Flight_Date_Want"];
                    if(!(typeof(dateVal)==='undefined'||dateVal==null||dateVal==''))
                        item["Flight_Date_Want"] =  moment(dateVal);
                    dateVal = item["ADDTS"];
                    if(!(typeof(dateVal)==='undefined'||dateVal==null||dateVal==''))
                        item["ADDTS"] =  moment(dateVal);
                    dateVal = item["EDITTS"];
                    if(!(typeof(dateVal)==='undefined'||dateVal==null||dateVal==''))
                        item["EDITTS"] =  moment(dateVal);
                    return item;
                });
            }
            var data = {ArrFinance:ArrChecked};
            $.messager.progress({
                text: '数据处理中......'
            });
            var url = "/Finances/AmountToatalSelted";
            var dgData =$dg.data();
            var opts = dgData.datagrid.options;
            $.ajax({
                type: "POST",
                datatype: "json",//接收的数据类型
                contentType: "application/json; charset=utf-8;",//告诉服务端 发送的数据类型
                async: true,
                data: JSON.stringify(data),
                url: url,
                success: function (data) {
                    $.messager.progress('close');
                    if (data) {
                        if (data.Success) {
                            setdgHeader($dg,data.ErrMsg);//设置datagrid-头部内容
                            $dg.datagrid('reload');
                        } else{
                            $.messager.alert('警告', data.ErrMsg);
                        }
                    }
                    else{
                        $.messager.alert('警告', '未知错误');
                    }
                },
                error: function () {
                    $.messager.progress('close');
                    $.messager.alert('警告', '数据处理中,出现网络错误');
                }
            });
        }
        //费用明细
        function ViewFeeDtl_datagrid(){
            var ArrChecked = $dg.datagrid("getChecked");            
            if(typeof ArrChecked==='undefined'||ArrChecked == null||ArrChecked.length<1){
                $.messager.alert("警告","至少需要选中一条数据，才能查看 费用明细");
                return false;
            }
            ArrChecked = ArrChecked.map(function(item){
                return {IsAr:item.IsAr,Id:item.Id};
            });

            //明细数据
            var opts_dtl = $dg_dtl.datagrid('options');
            opts_dtl.queryParams = {
                ArrFinance:ArrChecked
            };
            $dg_dtl.datagrid('reload');
        }
        //审核
        function audit(cancel) {
            var IsCancel = false;//取消审核
            if (!(typeof (cancel) === 'undefined' || cancel == null || cancel == '')) {
                IsCancel=true;
            }
            var ArrSelted = $dg.datagrid("getChecked");
            for(var i = 0;i<ArrSelted.length;i++){
                ArrSelted[i].Flight_Date_Want = datetimeformatter(ArrSelted[i].Flight_Date_Want);
                ArrSelted[i].ADDTS = datetimeformatter(ArrSelted[i].ADDTS);
                ArrSelted[i].Bill_Date = datetimeformatter(ArrSelted[i].Bill_Date);
            }
            if (typeof (ArrSelted) === 'undefined' || ArrSelted == null || ArrSelted.length < 1) {
                $.messager.alert('提示', '请至少选择一条数据，才能操作！');
                return false;
            } else {
                $.messager.progress({
                    text: '数据处理中......'
                });
                let param = { ArrFinance: ArrSelted };
                if(IsCancel)
                    param["AuditState"] = 0;//草稿
                let opts = $dg.datagrid('options');
                let url = opts.url.replace('GetData', 'Audit');
                $.ajax({
                    url: url,//'/Bms_Bill_Ars/Audit',
                    method: 'post',
                    data: param,
                    success: function (retdata) {
                        $.messager.progress('close');
                        if (typeof (retdata) === 'undefined' || retdata == null) {
                            $.messager.alert('警告', '数据格式不正确，请联系管理员！');
                        } else {
                            if (retdata.Success) {
                                $.messager.alert('提示', (IsCancel?"取消":"")+'审核成功！');
                                $dg.datagrid("reload");
                                //$dg.datagrid("clearChecked");
                            } else {
                                var errMsg = retdata.ErrMsg;
                                $.messager.alert('警告', errMsg);
                            }
                        }
                    },
                    error: function () {
                        $.messager.progress('close');
                        $.messager.alert('警告', '审核中出现网络错误！');
                    }
                });
            }
        }
        //编辑账单类型和结算方
        function ArApEdit_PopupWin(){
            var ArrSelted = $dg.datagrid("getChecked");
            if (typeof (ArrSelted) === 'undefined' || ArrSelted == null || ArrSelted.length < 1) {
                $.messager.alert('提示', '请至少选择一条数据，才能操作！');
                return false;
            }
            var IsLoadName = 'IsLoadArApEdit_PopupWin';
            DestoryPoupWinFunc();//销毁弹出框及js
            ArrIsLoadWin[IsLoadName] = false;//不要异步 每次都获取
            var url = '/Finances/ArApEdit_PopupWin';
            //异步获取 数据
            AsyncGetMyWin(url,IsLoadName , 'InitPopupEditWinFuc();', true);
            if($("#ArApEdit_PopupWin"))
                $("#ArApEdit_PopupWin").window('open');
            return false;
        }
        //开具D/N发票
        function AddDNFP(){
            var ArrChecked = $dg.datagrid("getChecked");         
            if (typeof (ArrChecked) === 'undefined' || ArrChecked == null || ArrChecked.length < 1) {
                $.messager.alert('提示', '请至少选择一条数据，才能操作！');
                return false;
            }
            $.messager.progress({
                text: '数据处理中......'
            });
            let param = { ArrFinance: ArrChecked };
            let opts = $dg.datagrid('options');
            let url = opts.url.replace('GetData', 'AddDNFP');
            $.ajax({
                url: url,//'/Finances/AddDNFP',
                method: 'post',
                data: param,
                success: function (retdata) {
                    $.messager.progress('close');
                    if (typeof (retdata) === 'undefined' || retdata == null) {
                        $.messager.alert('警告', '数据格式不正确，请联系管理员！');
                    } else {
                        if (retdata.Success) {
                            $.messager.alert('提示','开具D/N发票成功！');
                            $dg.datagrid("reload");
                            //$dg.datagrid("clearChecked");
                        } else {
                            var errMsg = retdata.ErrMsg;
                            $.messager.alert('警告', errMsg);
                        }
                    }
                },
                error: function () {
                    $.messager.progress('close');
                    $.messager.alert('警告', '开具D/N发票中出现网络错误！');
                }
            });
        }
        //账单移除
        var RemoveId =[];//记录移除的项
        function RemoveItem(){
            var $this = $("#finance_toolbar").find("a:eq(0)");
            var ArrSelted = $dg.datagrid("getChecked");
            if (typeof (ArrSelted) === 'undefined' || ArrSelted == null || ArrSelted.length < 1) {
                $.messager.alert('提示', '请至少选择一条数据，才能操作！');
                return false;
            }
            //记录移除的Id
            var ArrId = ArrSelted.map(function(item){return {IsAr:item.IsAr, Id:item.Id}});
            RemoveId = RemoveId.concat(ArrId);
            var opts = $dg.datagrid('options');
            opts.queryParams = {
                'filterRules': JSON.stringify(window.LastSearch),
                //'AddfilterRules': JSON.stringify(ArrAddSearch),
                'RemoveId':JSON.stringify(RemoveId),
            };
            removeit.call($this);
            $dg.data().datagrid.deletedRows=[];
        }
        //账单作废
        function BillCancel(){
            var ArrSelted = $dg.datagrid("getChecked");
            for(var i = 0;i<ArrSelted.length;i++){
                ArrSelted[i].Flight_Date_Want = datetimeformatter(ArrSelted[i].Flight_Date_Want);
                ArrSelted[i].ADDTS = datetimeformatter(ArrSelted[i].ADDTS);
                ArrSelted[i].Bill_Date = datetimeformatter(ArrSelted[i].Bill_Date);
            }
            if (typeof (ArrSelted) === 'undefined' || ArrSelted == null || ArrSelted.length < 1) {
                $.messager.alert('提示', '请至少选择一条数据，才能操作！');
                return false;
            }
            let param = { ArrFinance: ArrSelted };
            let opts = $dg.datagrid('options');
            let url = opts.url.replace('GetData', 'ArApCancel');
            $.ajax({
                url: url,//'/Finances/ArApCancel',
                method: 'post',
                data: param,
                success: function (retdata) {
                    $.messager.progress('close');
                    if (typeof (retdata) === 'undefined' || retdata == null) {
                        $.messager.alert('警告', '数据格式不正确，请联系管理员！');
                    } else {
                        if (retdata.Success) {
                            $.messager.alert('提示','账单作废成功！');
                            RemoveItem();
                        } else {
                            var errMsg = retdata.ErrMsg;
                            $.messager.alert('警告', errMsg);
                        }
                    }
                },
                error: function () {
                    $.messager.progress('close');
                    $.messager.alert('警告', '账单作废中出现网络错误！');
                }
            });
        }
        var ArrAddSearch =[];
        //增加查询
        function AddSearch(){
            $.messager.progress({
                text: '数据处理中......'
            });
            var dgData =$dg.data();
            var opts = dgData.datagrid.options;
            //var url = opts.url.replace('GetData', 'AddSearch');
            var params = setfilteropts();//设置查询条件

            if(typeof(params)==='undefined'||params==null||params.length>0){
                ArrAddSearch.push(params);
            }
            if(typeof(window.LastSearch)==='undefined'||window.LastSearch==null||!ObjectIsArray(window.LastSearch)){
                $.messager.progress('close');
                $.messager.alert("警告","结果集，没有筛选，不能 增加查询！");
                $('#financetable div.datagrid-view2 div.datagrid-body').prop({ scrollLeft: 0, scrollTop: 0 });
                return false;
            }
            //var postParam=[];//增加搜索，过滤 与原 搜索 相同的条件
            //for(var i in window.LastSearch){
            //    var item = window.LastSearch[i];
            //    var val = params.map(function(p){if(p.field==item.field) return p.value});
            //    if(val!=null && val!=''){
            //        if(val != item.value)
            //            postParam.push(item);
            //    }
            //    else
            //        postParam.push(item);
            //}

            var opts = $dg.datagrid('options');
            opts.queryParams = {
                'filterRules': JSON.stringify(window.LastSearch),
                'AddfilterRules': JSON.stringify(ArrAddSearch),
                'RemoveId':JSON.stringify(RemoveId),
            };
            $dg.datagrid('reload');
            $.messager.progress('close');
            ResetSearch();//清除增加搜索条件，并赋值最后一次 查询条件
            $('#financetable div.datagrid-view2 div.datagrid-body').prop({ scrollLeft: 0, scrollTop: 0 });
            return false;

            $.ajax({
                type: "POST",
                datatype: "json",//接收的数据类型
                contentType: "application/json; charset=utf-8;",//告诉服务端 发送的数据类型
                async: true,
                data: JSON.stringify({ "filterRules":  JSON.stringify(postParam) }),
                url: url,
                success: function (data) {
                    $.messager.progress('close');
                    if (data) {
                        if (data.Success) {
                            var ArrRows = $dg.datagrid("getRows");
                            if(!(typeof data.Rows ==='undefined'||data.Rows==null)){
                                if(ObjectIsArray(data.Rows)){
                                    for(var i in data.Rows){
                                        $dg.datagrid("appendRow",data.Rows[i]);
                                    }
                                }else
                                    $.messager.alert('警告',"返回数据格式不正确");
                            }else
                                $.messager.alert('警告',"返回数据为空");
                        } else{
                            $.messager.alert('警告', data.ErrMsg);
                        }
                    }
                    else{
                        $.messager.alert('警告', '未知错误');
                    }
                },
                error: function () {
                    $.messager.progress('close');
                    $.messager.alert('警告', '增加查询中,出现网络错误');
                }
            });
        }
        //重置搜索
        function ResetSearch(reload){
            $("#btnAddSearch").removeClass('active').blur();
            if(window.LastSearch){
                var SearchData={};
                var ArrdgComboId=[];
                for(var i in window.LastSearch){
                    var item = window.LastSearch[i];
                    var field = item.field+"_Q";
                    SearchData[field] = item.value;
                    var $dgcombo = $("#"+field,"#searchform");
                    var dgdata = $dgcombo.data("combogrid");
                    if(!(typeof dgdata==='undefined' || dgdata ==null))
                        ArrdgComboId.push(field);
                }
                $("#searchform").form('clear');
                $("#searchform").form('load',SearchData);
                //重设一下Combogrid
                for(var i in ArrdgComboId)
                    reloadPageCombogrid(ArrdgComboId[i]);
                if(!(typeof reload==='undefined'||reload==null||reload==''))
                    searchf();
            }
        }
        //应收/付提交
        function ArApSubmit(){
            var ArrChecked = $dg.datagrid("getChecked");
            if (typeof (ArrChecked) === 'undefined' || ArrChecked == null || ArrChecked.length < 1) {
                $.messager.alert('提示', '请至少选择一条数据，才能操作！');
                return false;
            }
            //ArrChecked = ArrChecked.map(function(item){
            //    if(item.IsAr==1||item.IsAr=='1')
            //        item.IsAr==true;
            //    else
            //        item.IsAr==false;
            //    return item;
            //});
            var IsLoadName = 'IsLoadSubmit_PopupWin';
            DestoryPoupWinFunc();//销毁弹出框及js
            ArrIsLoadWin[IsLoadName] = false;//不要异步 每次都获取
            var url = '/Finances/ArApSubmit_PopupWin';
            var postObj = {ArrFinance:ArrChecked};
            //异步获取 数据
            AsyncGetMyWin(url,IsLoadName, 'InitSubmitPopupWinFuc();', true, postObj);
            if($("#ArApSubmit_PopupWin"))
                $("#ArApSubmit_PopupWin").window('open');
            return false;
        }
        //添加/修改 提交号
        function ArApAddEditSubmit(_IsEdit){
            var IsEdit = false;
            if(!(typeof _IsEdit==='undefined'||_IsEdit==null||_IsEdit==''))
                IsEdit = true;
            var ArrChecked = $dg.datagrid("getChecked");

            if (typeof (ArrChecked) === 'undefined' || ArrChecked == null || ArrChecked.length < 1) {
                $.messager.alert('提示', '请至少选择一条数据，才能操作！');
                return false;
            }
            var Sumbmit_No = ArrChecked[0].Sumbmit_No;
            var viewText = IsEdit?'修改-'+Sumbmit_No+'-为：':'添加提交号：';
            $.messager.prompt((IsEdit?'修改':'添加')+'提交号', viewText, function(r){
                if (r){
                    $.messager.progress({
                        text: '数据处理中......'
                    });
                    var url = "/Finances/ArApAddSubmit";
                    var postdata = {ArrFinance:ArrChecked, Sumbmit_No:r,IsEdit:IsEdit};
                    $.ajax({
                        type: "POST",
                        datatype: "json",//接收的数据类型
                        contentType: "application/json; charset=utf-8",//告诉服务端 发送的数据类型
                        async: true,
                        data: JSON.stringify(postdata),
                        url: url,
                        success: function (data) {
                            $.messager.progress('close');
                            if (data) {
                                if (data.Success) {
                                    for(var i in ArrChecked){
                                        var item =ArrChecked[i];
                                        var rowIndex = $dg.datagrid("getRowIndex",item);
                                        $.extend(item,data.data);
                                        $dg.datagrid("refreshRow",rowIndex);
                                    }
                                } else{
                                    $.messager.alert('警告', data.ErrMsg);
                                }
                            }
                            else{
                                $.messager.alert('警告', '未知错误');
                            }
                        },
                        error: function () {
                            $.messager.progress('close');
                            $.messager.alert('警告', '数据处理中,出现网络错误');
                        }
                    });
                }
            });
        }
        //取消提交
        function ArApCancelSubmit()
        {
            var ArrChecked = $dg.datagrid("getChecked");           
            if (typeof (ArrChecked) === 'undefined' || ArrChecked == null || ArrChecked.length < 1) {
                $.messager.alert('提示', '请至少选择一条数据，才能操作！');
                return false;
            }
            $.messager.progress({
                text: '数据处理中......'
            });
            var url = "/Finances/ArApCancelSubmit";
            var postdata = {ArrFinance:ArrChecked};
            $.ajax({
                type: "POST",
                datatype: "json",//接收的数据类型
                contentType: "application/json; charset=utf-8",//告诉服务端 发送的数据类型
                async: true,
                data: JSON.stringify(postdata),
                url: url,
                success: function (data) {
                    $.messager.progress('close');
                    if (data) {
                        if (data.Success) {
                            for(var i in ArrChecked){
                                var item =ArrChecked[i];
                                var rowIndex = $dg.datagrid("getRowIndex",item);
                                item.Sumbmit_No = "";
                                item.Sumbmit_Status = false;
                                item.Sumbmit_Date = "";
                                item.Sumbmit_Id = "";
                                item.Sumbmit_Name= "";
                                $dg.datagrid("refreshRow",rowIndex);
                            }
                            if(!(typeof(data.ErrMsg)==='undefined'||data.ErrMsg ==null||data.ErrMsg=='')){
                                $.messager.alert('警告', data.ErrMsg);
                            }
                        } else{
                            $.messager.alert('错误', data.ErrMsg);
                        }
                    }
                    else{
                        $.messager.alert('错误', '未知错误');
                    }
                },
                error: function () {
                    $.messager.progress('close');
                    $.messager.alert('警告', '数据处理中,出现网络错误');
                }
            });
        }
        //开票
        function ArApAddInvoice(){
            var ArrChecked = $dg.datagrid("getChecked");           
            if (typeof (ArrChecked) === 'undefined' || ArrChecked == null || ArrChecked.length < 1) {
                $.messager.alert('提示', '请至少选择一条数据，才能操作！');
                return false;
            }
            var IsLoadName = 'IsLoadArApAddInvoice_PopupWin';
            DestoryPoupWinFunc();//销毁弹出框及js
            ArrIsLoadWin[IsLoadName] = false;//不要异步 每次都获取
            var postObj = {ArrFinance:ArrChecked};
            var url = '/Finances/ArApAddInvoice_PopupWin';
            //异步获取 数据
            AsyncGetMyWin(url,IsLoadName , 'InitPopupAddInvoiceWinFuc();', true, postObj);
            if($("#ArApAddInvoice_PopupWin"))
                $("#ArApAddInvoice_PopupWin").window('open');
            return false;
        }
        //取消发票
        function CancelInvoice(){
            var ArrChecked = $dg.datagrid("getChecked");           
            if (typeof (ArrChecked) === 'undefined' || ArrChecked == null || ArrChecked.length < 1) {
                $.messager.alert('提示', '请至少选择一条数据，才能操作！');
                return false;
            }
            $.messager.progress({
                text: '数据处理中......'
            });
            var url = "/Finances/CancelInvoice";
            var postdata = {ArrFinance:ArrChecked};
            $.ajax({
                type: "POST",
                datatype: "json",//接收的数据类型
                contentType: "application/json; charset=utf-8",//告诉服务端 发送的数据类型
                async: true,
                data: JSON.stringify(postdata),
                url: url,
                success: function (data) {
                    $.messager.progress('close');
                    if (data) {
                        if (data.Success) {
                            for(var i in ArrChecked){
                                var item =ArrChecked[i];
                                var rowIndex = $dg.datagrid("getRowIndex",item);
                                $.extend(item,data.data);
                                $dg.datagrid("refreshRow",rowIndex);
                            }
                        } else{
                            $.messager.alert('警告', data.ErrMsg);
                        }
                    }
                    else{
                        $.messager.alert('警告', '未知错误');
                    }
                },
                error: function () {
                    $.messager.progress('close');
                    $.messager.alert('警告', '数据处理中,出现网络错误');
                }
            });
        }
        //发票作废
        function InvoiceCancel(){
            $.messager.prompt('发票作废', '请输入要作废的发票号', function(r){
                if (r){
                    $.messager.progress({
                        text: '数据处理中......'
                    });
                    var url = "/Finances/InvoiceCancel";
                    var postdata = {Invoice_No:r};
                    $.ajax({
                        type: "POST",
                        datatype: "json",//接收的数据类型
                        contentType: "application/json; charset=utf-8",//告诉服务端 发送的数据类型
                        async: true,
                        data: JSON.stringify(postdata),
                        url: url,
                        success: function (data) {
                            $.messager.progress('close');
                            if (data) {
                                if (data.Success) {
                                    $dg.datagrid("reload");
                                } else{
                                    $.messager.alert('警告', data.ErrMsg);
                                }
                            }
                            else{
                                $.messager.alert('警告', '未知错误');
                            }
                        },
                        error: function () {
                            $.messager.progress('close');
                            $.messager.alert('警告', '数据处理中,出现网络错误');
                        }
                    });
                }
            });
        }
        //签收
        function SignIn(){
            var ArrChecked = $dg.datagrid("getChecked");          
            if (typeof (ArrChecked) === 'undefined' || ArrChecked == null || ArrChecked.length < 1) {
                $.messager.alert('提示', '请至少选择一条数据，才能操作！');
                return false;
            }
            var IsLoadName = 'IsLoadSubmit_PopupWin';
            DestoryPoupWinFunc();//销毁弹出框及js
            ArrIsLoadWin[IsLoadName] = false;//不要异步 每次都获取
            var url = '/Finances/ArApSignIn_PopupWin';
            var postObj = {ArrFinance:ArrChecked};
            //异步获取 数据
            AsyncGetMyWin(url,IsLoadName, 'InitSignInPopupWinFuc();', true, postObj);
            if($("#ArApSignIn_PopupWin"))
                $("#ArApSignIn_PopupWin").window('open');
            return false;
        }
        //取消签收
        function SignInCancel(){
            Cancel = false;
            if(!(typeof _Cancel==='undefined'||_Cancel==null||_Cancel==''))
                Cancel = true;
            var ArrChecked = $dg.datagrid("getChecked");            
            if (typeof (ArrChecked) === 'undefined' || ArrChecked == null || ArrChecked.length < 1) {
                $.messager.alert('提示', '请至少选择一条数据，才能操作！');
                return false;
            }
            $.messager.progress({
                text: '数据处理中......'
            });
            var url = "/Finances/SignInCancel";
            var postdata = {ArrFinance:ArrChecked};
            $.ajax({
                type: "POST",
                datatype: "json",//接收的数据类型
                contentType: "application/json; charset=utf-8",//告诉服务端 发送的数据类型
                async: true,
                data: JSON.stringify(postdata),
                url: url,
                success: function (data) {
                    $.messager.progress('close');
                    if (data) {
                        if (data.Success) {
                            for(var i in ArrChecked){
                                var item =ArrChecked[i];
                                var rowIndex = $dg.datagrid("getRowIndex",item);
                                $.extend(item,data.data);
                                $dg.datagrid("refreshRow",rowIndex);
                            }
                            if(!(typeof(data.ErrMsg)==='undefined'||data.ErrMsg ==null||data.ErrMsg=='')){
                                $.messager.alert('警告', data.ErrMsg);
                            }
                        } else{
                            $.messager.alert('警告', data.ErrMsg);
                        }
                    }
                    else{
                        $.messager.alert('警告', '未知错误');
                    }
                },
                error: function () {
                    $.messager.progress('close');
                    $.messager.alert('警告', '数据处理中,出现网络错误');
                }
            });
        }
        //销账
        function ArApSellAccount(){
            var ArrChecked = $dg.datagrid("getChecked");           
            if (typeof (ArrChecked) === 'undefined' || ArrChecked == null || ArrChecked.length < 1) {
                $.messager.alert('提示', '请至少选择一条数据，才能操作！');
                return false;
            }
            var IsLoadName = 'IsLoadArApAddInvoice_PopupWin';
            DestoryPoupWinFunc();//销毁弹出框及js
            ArrIsLoadWin[IsLoadName] = false;//不要异步 每次都获取
            var postObj = {ArrFinance:ArrChecked};
            var url = '/Finances/ArApSellAccount_PopupWin';
            //异步获取 数据
            AsyncGetMyWin(url,IsLoadName , 'InitSellAccount_PopupWinFuc();', true, postObj);
            if($("#ArApSellAccount_PopupWin"))
                $("#ArApSellAccount_PopupWin").window('open');
            return false;
        }
        //航天增值税
        function ApValAddedTax(){
            var ArrChecked = $dg.datagrid("getChecked");
            if (typeof (ArrChecked) === 'undefined' || ArrChecked == null || ArrChecked.length != 1) {
                $.messager.alert('提示', '只能选择一条数据，才能操作！');
                return false;
            }
            var IsLoadName = 'IsLoadApValAddedTax_PopupWin';
            DestoryPoupWinFunc();//销毁弹出框及js
            ArrIsLoadWin[IsLoadName] = false;//不要异步 每次都获取
            var postObj = {OFinance:ArrChecked[0]};
            var url = '/Finances/ApValAddedTax_PopupWin';
            //异步获取 数据
            AsyncGetMyWin(url,IsLoadName , 'InitApValAddedTax_PopupWinFuc();', true, postObj);
            if($("#ApValAddedTax_PopupWin"))
                $("#ApValAddedTax_PopupWin").window('open');
            return false;
        }
        //页面加载结束时
        $(function () {
            var opts = $dg.datagrid('options');
            //读取用户 设置的 列宽与顺序（formatter-func方法Json转换后 会丢失）
            var dg_id = $dg.attr('id');
            var ArrFieldNoWidth = getdg_FieldNoWidth(dg_id);//获取 上次设置的 列宽和顺序
            if (!ObjectIsEmpty(ArrFieldNoWidth)) {
                var ArrFormatterCell = opts.columns[0].filter(function (item) {
                    if (!ObjectIsEmpty(item.formatter))
                        return true;
                    else
                        return false;
                });
                $.each(ArrFieldNoWidth, function () {
                    for (var i in ArrFormatterCell) {
                        var item = ArrFormatterCell[i];
                        if (this.field == item.field)
                            this.formatter = item.formatter;
                    }
                });
                //设置 用户上次设置的 列宽和顺序
                opts.columns[0] = ArrFieldNoWidth;
                //初始化datagrid，以便列宽和顺序 生效
                $dg.datagrid();
            }
            //设置列可移动
            $dg.datagrid("columnMoving");
            setfilteropts();
            opts.url = '/Finances/GetData';
            //opts.onClickCell = onClickCell;
            //opts.onBeginEdit = onBeginEdit;
            opts.onSelect = onSelect;
            opts.onDblClickRow = onDblClickRow;
            opts.onLoadSuccess = onLoadSuccess;
            //$dg.datagrid('reload');
            //明细数据

            ////读取用户 设置的 列宽与顺序（formatter-func方法Json转换后 会丢失）
            //var dg_id = $dg.attr('id');
            //var ArrFieldNoWidth = getdg_FieldNoWidth(dg_id);//获取 上次设置的 列宽和顺序
            //if (!ObjectIsEmpty(ArrFieldNoWidth)) {
            //    var ArrFormatterCell = opts.columns[0].filter(function (item) {
            //        if (!ObjectIsEmpty(item.formatter))
            //            return true;
            //        else
            //            return false;
            //    });
            //    $.each(ArrFieldNoWidth, function () {
            //        for (var i in ArrFormatterCell) {
            //            var item = ArrFormatterCell[i];
            //            if (this.field == item.field)
            //                this.formatter = item.formatter;
            //        }
            //    });
            //    //设置 用户上次设置的 列宽和顺序
            //    opts.columns[0] = ArrFieldNoWidth;
            //    //初始化datagrid，以便列宽和顺序 生效
            //    $dg.datagrid();
            //}
            ////设置列可移动
            $dg.datagrid("columnMoving");

            var opts_dtl = $dg_dtl.datagrid('options');
            opts_dtl.url = '/Finances/GetDtlData';
            opts_dtl.onLoadSuccess = onLoadSuccess;

            $("#btnTotalSelted").on("click",function(){$(this).blur();AmountTotalSelted();});
            $("#btnFeeDtl").on("click",function(){$(this).blur();ViewFeeDtl_datagrid();});
            $("#btnAudit,#btnAuditCancel").on("click",function(){
                $(this).blur();
                if($(this).attr("id") == "btnAudit")
                    audit();
                else
                    audit(1);
            });
            $("#btnEditBillType,#btnEdit").on("click",function(){$(this).blur();ArApEdit_PopupWin();});
            $("#btnBillRemove").on("click",function(){$(this).blur();RemoveItem();});
            $("#btnBillCancel").on("click",function(){$(this).blur();BillCancel();});
            $("#btnAddSearch").on("click",function(){
                $(this).blur();
                if(!$(this).hasClass('active')){
                    AddSearch();
                    $(this).addClass('active').blur();
                }
                else{
                    //ResetSearch(1);//重置搜索
                }
            });
            $("#btnApSubmit,#btnArSubmit").on("click",function(){$(this).blur();ArApSubmit();});
            $("#btnAddSubmit,#btnEditSubmit").on("click",function(){
                $(this).blur();
                if($(this).attr("id") == "btnEditSubmit")
                    ArApAddEditSubmit(1);
                else
                    ArApAddEditSubmit();
            });
            $("#btnAddDNFP").on("click",function(){$(this).blur();AddDNFP();});
            $("#btnCancelSubmit").on("click",function(){$(this).blur();ArApCancelSubmit();});
            $("#btnInvoice").on("click",function(){$(this).blur();ArApAddInvoice();});
            $("#btnCancelInvoice,#btnInvoiceCancel").on("click",function(){
                $(this).blur();
                if($(this).attr("id") == "btnCancelInvoice")
                    CancelInvoice();
                else
                    InvoiceCancel();
            });
            $("#btnSignIn,#btnSignInCancel").on("click",function(){
                $(this).blur();
                if($(this).attr("id") == "btnSignInCancel")
                    SignInCancel();
                else
                    SignIn();
            });
            $("#btnSettleAccount").on("click",function(){$(this).blur();ArApSellAccount();});
            $("#btnNASATaxRate").on("click",function(){$(this).blur();ApValAddedTax();});
            ////默认关闭 部分搜索条件（直接隐藏，easyui 控件 宽度会缩小）
            //var $a = $("#div_search").panel('panel').find("div.panel-header div.panel-tool a:first");
            //$a.trigger('click');
        });
        //自动添加 textbox 或 text的值 
        function AutoAddFilterRule($dg_) {
            var ColumnsFields = $dg_.datagrid('getColumnFields');
            $.each(ColumnsFields, function (i, ColumnName) {
                var input = $dg_.datagrid('getFilterComponent', ColumnName);
                if (!(input.data("datebox") || input.data("datetimebox") || input.data("combobox") || input.data("checkbox") || input.data("combotree") || input.data("combogrid") || input.data("numberbox"))) {
                    var rule = $dg_.datagrid('getFilterRule', ColumnName);
                    var value = input.val();
                    if (!(typeof (value) === 'undefined' || value == null || value == '')) {
                        if ((rule && rule.value != value) || !rule) {
                            $dg_.datagrid('addFilterRule', {
                                field: ColumnName,
                                op: 'equal',
                                value: value
                            });
                        }
                    } else {
                        if (rule) {
                            $dg_.datagrid('removeFilterRule', ColumnName);
                        }
                    }
                }
            });
        }
        //自适应页面大小
        function MyNavResize() {
            var opts = $("#navbar-minimalize").NavResize('getOptions');
            opts.Auto = false;
            opts.OnNavResizefunc = function () {
                //$("#edit_div_one").css('width', "100%");
                //$("#edit_div_two").css('width', "100%");
                //$("#OrderInfo").datagrid("resize", { width: "100%" });
                //$("#OrderDetail").datagrid("resize", { width: "100%" });
                //$("#ProductNameMerge").datagrid("resize", { width: "100%" });
                //$("#Order_Head_panel").panel("resize", { width: "100%" });
                //setTimeout(function () {
                //    var paddigLeftRight = { "padding-left": "0px", "margin-left": "0px", "padding-right": "0px", "margin-right": "0px" };
                //    $("#edit_div_one").css(paddigLeftRight);
                //    $("#edit_div_two").css(paddigLeftRight);
                //    $("#OrderInfo").css(paddigLeftRight);
                //    $("#OrderDetail").css(paddigLeftRight);
                //    $("#ProductNameMerge").css(paddigLeftRight);
                //    $("#Order_Head_panel").css(paddigLeftRight);
                //    SetbuttonssWidth();
                //}, 100);
            };
        }
        //导出报表
        $("#btnExportE").on('click', function (e) {
            $('#BMS_Export').menu('show', {
                hideOnUnhover: false,
                left: e.pageX,
                top: e.pageY - $('#BMS_Export').width()
            });
        });
        //打印报表
        $("#btnExportP").on('click', function (e) {
            $('#BMS_Print').menu('show', {
                hideOnUnhover: false,
                left: e.pageX,
                top: e.pageY,
            });
        });
      
    </script>
}